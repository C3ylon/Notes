# è™šæ‹Ÿæœºä¸‹çš„OpenWrtæŒ‡å—

## 0 ç®€ä»‹

OpenWrtæ˜¯ä¸€ä¸ªåŸºäºLinuxçš„å¼€æºè·¯ç”±ç³»ç»Ÿï¼Œé€‰æ‹©OpenWrtçš„ç†ç”±ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š

1. éœ€è¦ä¸€ä¸ªèƒ½æ¥ç®¡æ‰€æœ‰æœ¬åœ°æµé‡çš„**é€æ˜ä»£ç†**ã€‚

   Windowså®¢æˆ·ç«¯å¸¸ç”¨çš„ä»£ç†è½¯ä»¶å¦‚CFW(*Clash for Windows*)ç­‰ï¼Œå…¶åœ¨æœªå¼€å¯`TUN`æ¨¡å¼ä¸‹é€šå¸¸åªèƒ½ä»£ç†ç½‘é¡µæµé‡ï¼Œè€Œä¸èƒ½ä»£ç†ç»å¤§éƒ¨åˆ†è½¯ä»¶çš„æµé‡ï¼ˆè¿™äº›è½¯ä»¶ä¸éµå¾ªç³»ç»Ÿä»£ç†è®¾å®šï¼‰ã€‚æœ€å¸¸è§çš„æƒ…å†µå°±æ˜¯ä½¿ç”¨CMDæ§åˆ¶å°æ‰§è¡Œ`pip install`æŒ‡ä»¤å®‰è£…PythonåŒ…æ—¶ä¸‹è½½é€Ÿåº¦å¾ˆæ…¢ï¼Œä½¿ç”¨`git push`æŒ‡ä»¤æ—¶ç»å¸¸ä¸Šä¼ å¤±è´¥ï¼Œå› æ— æ³•ä»£ç†UDPæµé‡å¯¼è‡´WebRTCæ³„éœ²ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯æµé‡æ²¡æœ‰è¢«æ¥ç®¡çš„ä½“ç°ã€‚å¦‚æœæœ‰ä¸€ä¸ªèƒ½å¤Ÿæ¥ç®¡å…¨éƒ¨æœ¬åœ°æµé‡çš„é€æ˜ä»£ç†å°†ä¸ä¼šå‡ºç°ä¸Šè¿°é—®é¢˜ã€‚

2. éœ€è¦ä¸€ä¸ªèƒ½**é«˜åº¦å®¢åˆ¶åŒ–**ç½‘ç»œç®¡ç†çš„ç³»ç»Ÿã€‚

   OpenWrtçš„è‡ªç”±åº¦æé«˜ï¼Œèƒ½ä»å„ä¸ªç»†èŠ‚å®¢åˆ¶åŒ–ç½‘ç»œç®¡ç†ï¼Œæ¯”å¦‚DNSè½¬å‘ã€è´Ÿè½½å‡è¡¡ã€æµé‡åˆ†æµç­‰ï¼Œä¹Ÿæœ‰å„ç±»ä¸°å¯Œçš„æ’ä»¶å¯ä»¥å³æ‹¿å³ç”¨ï¼Œæ¯”å¦‚å±è”½ç½‘é¡µç«¯å¹¿å‘Šã€è§£é”éŸ³ä¹æ’­æ”¾è½¯ä»¶ç°è‰²æ›²ç›®ç­‰ã€‚

ä½¿ç”¨OpenWrtç³»ç»Ÿæœ€å¥½æ˜¯è´­ä¹°CPUå’Œç½‘å¡æ€§èƒ½éƒ½è¾¾æ ‡çš„è·¯ç”±å™¨ç¡¬ä»¶ï¼Œä½†æ˜¯è¿™ç±»è·¯ç”±å™¨ä»·æ ¼æ™®éè¾ƒé«˜ï¼Œå¦‚æœé€‰å¯æ‰©å±•æ€§å¼ºçš„x86æ¶æ„è·¯ç”±å™¨ï¼Œè¿˜éœ€è¦å†å•ç‹¬åŠ è£…ç¡¬ç›˜å’Œå†…å­˜ï¼Œè¿™ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„æˆæœ¬ã€‚

å¦‚æœæƒ³é›¶æˆæœ¬ä½“éªŒä¹‹åå†è´­ä¹°ç¡¬ä»¶ï¼Œé‚£ä¹ˆæœ€å¥½çš„é€‰æ‹©å°±æ˜¯å°†OpenWrtå®‰è£…åœ¨è™šæ‹Ÿæœºé‡Œæ¨¡æ‹Ÿæ“ä½œä¸€éã€‚é€šè¿‡è™šæ‹Ÿæœºæ¨¡æ‹Ÿæ¸…æ¥šæ“ä½œæµç¨‹ä¹‹åï¼Œå†åˆ‡æ¢åˆ°ç‰©ç†ç¯å¢ƒä¼šéå¸¸å®¹æ˜“ä¸Šæ‰‹ã€‚å…¶å®å¦‚æœä¸ä»‹æ„ä¸€ç›´å°†è™šæ‹Ÿæœºè¿è¡Œåœ¨åå°çš„è¯ï¼Œä¹Ÿå®Œå…¨å¯ä»¥æŠŠè™šæ‹ŸæœºOpenWrtå½“ä½œä¸»åŠ›è·¯ç”±æ¥ä½¿ç”¨ã€‚

æœ¬æ–‡æ‰€ç”¨çš„è™šæ‹Ÿæœºå¹³å°æ˜¯VMware Workstation Proï¼Œæ‰€æœ‰è½¯ä»¶åŠå›ºä»¶éƒ½é‡‡ç”¨å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼Œä¸”æ‰€æœ‰å®‰è£…æºå‡é‡‡ç”¨å®˜æ–¹æºï¼Œä¸ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹æ‰“åŒ…/æ•´åˆçš„å·¥å…·ã€‚

è™šæ‹Ÿæœºå®‰è£…OpenWrtå¯ä»¥é‡‡ç”¨ä¸¤ç§ç½‘ç»œç»“æ„ï¼š

1. ä»…ä½¿ç”¨lançš„æ—è·¯ç½‘å…³
2. lan-wanç»“æ„çš„è·¯ç”±

ä»¥ä¸Šä¸¤ç§ç½‘ç»œç»“æ„å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä¸‹é¢å°†åˆ†åˆ«è®²è§£å®‰è£…æ­¥éª¤ã€‚å†™è¿™ç¯‡ç¬”è®°æ—¶æ‰€æœ‰æ“ä½œæ­¥éª¤éƒ½æ˜¯ç»è¿‡é€æ­¥å¤ç°çš„ã€‚é™„å½•éƒ¨åˆ†æ˜¯ä¸€äº›æ‚é¡¹å†…å®¹çš„æ±‡æ€»ï¼Œä¸»è¦ç”¨äºä¸ªäººè®°å½•ã€‚

## 1 å…±é€šå‡†å¤‡

ä¸ºå®ç°å‰è¿°ä¸¤ç§ç½‘ç»œç»“æ„éƒ½æœ‰å…±é€šçš„éœ€è¦å‡†å¤‡çš„éƒ¨åˆ†ï¼š

1. ä¸‹è½½OpenWrtå›ºä»¶
2. è½¬æ¢OpenWrtå›ºä»¶æ ¼å¼
3. ä¸‹è½½VMwareè™šæ‹Ÿæœº
4. å®‰è£…è™šæ‹Ÿæœº

### 1.1 ä¸‹è½½OpenWrtå›ºä»¶

[å›ºä»¶åœ°å€](https://downloads.openwrt.org/releases/ "https://downloads.openwrt.org/releases/")

ä¸‹æ‹‰ä¸‹è½½é¡µé¢åˆ°æœ€åº•ç«¯ï¼Œæ‰¾åˆ°å¦‚å›¾æ‰€ç¤ºçš„æœ€æ–°å‘è¡Œç‰ˆã€‚

![æœ€æ–°å›ºä»¶](./pics/OpenWrt/1.1.png)

> æ³¨æ„ï¼šOpenWrtä»`22.03.0`ç‰ˆæœ¬å¼€å§‹ï¼Œå°†é…ç½®é˜²ç«å¢™çš„å·¥å…·ä»`iptables`æ›¿æ¢ä¸ºäº†`nftables`ã€‚è¿™ä¸¤è€…çš„é…ç½®è¯­æ³•**ä¸å…¼å®¹**ï¼Œä¼šå¯¼è‡´éƒ¨åˆ†æ²¡æœ‰åŠæ—¶å‡çº§é˜²ç«å¢™é…ç½®çš„æ’ä»¶æ— æ³•è¿è¡Œåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„OpenWrtç³»ç»Ÿä¸Šï¼Œæ¯”å¦‚ç½‘æ˜“çš„UUåŠ é€Ÿå™¨æ’ä»¶ï¼Œç›®å‰ä¸æ”¯æŒ`nftables`ã€‚å¦‚æœæœ‰ä½¿ç”¨è¿™ç±»æ’ä»¶çš„éœ€æ±‚ï¼Œåº”å½“é€‰æ‹©`21.02.7`åŠå…¶ä¹‹å‰çš„ç‰ˆæœ¬ã€‚

è¿›å…¥`/targets/x86/64/`ï¼Œé€‰æ‹©ç¬¬ä¸€é¡¹ä¸‹è½½ã€‚

![å›ºä»¶ç‰ˆæœ¬](./pics/OpenWrt/1.2.png)

> `ext4`ä¸`squashfs`çš„åŒºåˆ«ä¸»è¦åœ¨ rootfs (æ ¹æ–‡ä»¶ç³»ç»Ÿ)ï¼š
>
> + `squashfs`æ˜¯**åªè¯»æ–‡ä»¶ç³»ç»Ÿ**ï¼Œå‹ç¼©æ ¼å¼ï¼›`ext4`æ˜¯**å®Œæ•´è¯»å†™ç³»ç»Ÿ**ï¼Œæœªè¢«å‹ç¼©ã€‚
> + `squashfs`ä½œä¸ºç³»ç»Ÿåªè¯»éƒ¨åˆ†ä¸å¯ä¿®æ”¹ï¼Œç›¸å½“äºå›ºä»¶é•œåƒåŸæ ·ï¼Œç”¨æˆ·ä¿®æ”¹éƒ¨åˆ†æŒ‚è½½åœ¨`/overlay`ï¼Œæ‰€æœ‰è®¾ç½®ä¿®æ”¹ã€æ–°å®‰è£…è½¯ä»¶ç­‰éƒ½å†™åœ¨è¿™é‡Œï¼›`ext4`å¯ä»¥ç›´æ¥ä¿®æ”¹`/etc`æˆ–å®‰è£…è½¯ä»¶åŒ…ï¼Œå’Œä¼ ç»Ÿ Linux ç±»ä¼¼ã€‚
>
> å› æ­¤å¯¹äºOpenWrtç³»ç»Ÿçš„å…·ä½“åº”ç”¨åœºæ™¯æ¥è¯´ï¼š
>
> + `ext4`å¯ä»¥æ‰©å±•ç£ç›˜ç©ºé—´å¤§å°ï¼Œè€Œ`squashfs`åˆ™ä¸èƒ½ã€‚
> + `squashfs`å¯ä»¥ä½¿ç”¨é‡ç½®åŠŸèƒ½æ¢å¤å‡ºå‚è®¾ç½®ï¼Œè€Œ`ext4`åˆ™ä¸èƒ½ã€‚
>
> é‰´äºæœ¬æ–‡å®‰è£…OpenWrtæ˜¯åœ¨è™šæ‹Ÿæœºç¯å¢ƒä¸‹ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä½¿ç”¨è™šæ‹Ÿæœºå¿«ç…§åŠŸèƒ½æ¥å¤‡ä»½å’Œæ¢å¤è®¾ç½®ï¼Œå› æ­¤é‡‡ç”¨`ext4`æ ¼å¼ã€‚å¦‚æœæ˜¯å®‰è£…åœ¨x86æ¶æ„çš„å®ä½“è·¯ç”±å™¨ç¡¬ä»¶ä¸Šä¹Ÿæ¨èå°½å¯èƒ½ä½¿ç”¨`ext4`æ ¼å¼ã€‚
>
> æ–‡ä»¶åå…¶ä½™åç¼€åŒºåˆ«ï¼š
>
> |æ–‡ä»¶å|æ˜¯å¦å«å¼•å¯¼|æ˜¯å¦æ”¯æŒ UEFI|è¯´æ˜|
> | :--- |:---:|:---:|:---|
> |`generic-ext4-combined-efi.img.gz`|âˆš|âˆš|å¸¦ UEFI å¯åŠ¨æ”¯æŒçš„å®Œæ•´ ext4 ç³»ç»Ÿé•œåƒ|
> |`generic-ext4-combined.img.gz`|âˆš|Ã—|åªæ”¯æŒä¼ ç»Ÿ BIOS å¯åŠ¨çš„å®Œæ•´ ext4 ç³»ç»Ÿé•œåƒ|
> |`generic-ext4-rootfs.img.gz`|Ã—|Ã—|ä»…åŒ…å« root æ–‡ä»¶ç³»ç»Ÿéƒ¨åˆ†ï¼Œä¸å¯å•ç‹¬å¯åŠ¨|

ç”¨è§£å‹å·¥å…·è§£å‹å¾—åˆ°ä¸€ä¸ª`.img`æ ¼å¼çš„æ˜ åƒæ–‡ä»¶ã€‚

> æ³¨æ„ï¼šä½¿ç”¨7zè§£å‹æ—¶å¯èƒ½ä¼šæŠ¥é”™: *æœ‰æ•ˆæ•°æ®å¤–åŒ…å«é¢å¤–æ•°æ® : openwrt-23.05.3-x86-64-generic-ext4-combined-efi.img*ã€‚æ— è§†è¯¥æŠ¥é”™å³å¯ã€‚åŸå› æ˜¯å‹ç¼©æ–‡ä»¶é™„å¸¦äº† SHA æ ¡éªŒæˆ–ç­¾åä¿¡æ¯ã€‚

### 1.2 è½¬æ¢OpenWrtå›ºä»¶æ ¼å¼

ä¸‹è½½StarWind V2V Converterè½¬æ¢å™¨ï¼Œè¯¥è½¬æ¢å™¨å¯ä»¥å°†`.img`æ ¼å¼çš„æ˜ åƒæ–‡ä»¶è½¬åŒ–ä¸º`.vmdk`æ ¼å¼çš„è™šæ‹Ÿæœºç£ç›˜æ–‡ä»¶ã€‚

[è½¬æ¢å™¨åœ°å€](https://www.starwindsoftware.com/tmplink/starwindconverter.exe "https://www.starwindsoftware.com/tmplink/starwindconverter.exe")

è¿è¡ŒStarWind V2V Converterè½¬æ¢å™¨ï¼š

+ Select the location of the image to convert: é€‰æ‹©ç¬¬äºŒé¡¹ Local file(File on the local machine)ã€‚
+ Source image: é€‰æ‹©ä¹‹å‰ä¸‹è½½çš„`.img`æ˜ åƒæ–‡ä»¶è·¯å¾„ã€‚
+ Select the location of the destination image: é€‰æ‹©ç¬¬ä¸€é¡¹ Local file(File on the local machine)ã€‚
+ Select destination image format: é€‰æ‹©ç¬¬ä¸€é¡¹ VMDK(VMware Virtual Machine Disk)ã€‚
+ Select option for VMDK image format: é€‰æ‹©ç¬¬ä¸€é¡¹ VMware Workstation growable imageã€‚ä½¿ç”¨è¯¥é€‰é¡¹åˆ›å»ºå‡ºçš„ç£ç›˜æ–‡ä»¶æ˜¯å¯æ‰©å®¹çš„ã€‚
+ é€‰æ‹©å¥½ç›®çš„è·¯å¾„ä¹‹åç›´æ¥ convert å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ª`.vmdk`åç¼€çš„ç£ç›˜æ–‡ä»¶ã€‚

### 1.3 ä¸‹è½½VMwareè™šæ‹Ÿæœº

ä¸‹è½½VMware Workstation Proã€‚å½“å‰æœ€æ–°ç‰ˆæœ¬ä¸º17ã€‚

[VMwareä¸‹è½½åœ°å€](https://www.vmware.com/go/getworkstation-win "https://www.vmware.com/go/getworkstation-win")

åœ¨å®‰è£…æ—¶ä½¿ç”¨keyæ¿€æ´»ã€‚~~ï¼ˆä¸€ä¸ªå¯ç”¨key: MC60H-DWHD5-H80U9-6V85M-8280Dï¼‰~~

### 1.4 å®‰è£…è™šæ‹Ÿæœº

å°†ä¹‹å‰è½¬æ¢å¾—åˆ°çš„vmdkæ–‡ä»¶æ”¾å…¥ä¸€ä¸ªæ–°å»ºæ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶å¤¹å°†ç”¨ä½œè™šæ‹Ÿæœºæ–‡ä»¶å¤¹ã€‚

+ æ‰“å¼€VMwareï¼Œé€‰æ‹© æ–‡ä»¶->æ–°å»ºè™šæ‹Ÿæœº->è‡ªå®šä¹‰(é«˜çº§)
+ ç¡¬ä»¶å…¼å®¹æ€§ é€‰æ‹©æœ€ä¸Šé¢çš„ä¸€é¡¹ï¼ˆå½“å‰æ˜¯Workstation 17.xï¼‰
+ å®‰è£…æ¥æº é€‰æ‹©ç¨åå®‰è£…æ“ä½œç³»ç»Ÿ
+ å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ é€‰æ‹©Linuxï¼Œç‰ˆæœ¬ é€‰æ‹©å…¶ä»–Linux 5.xå†…æ ¸64ä½
+ è™šæ‹Ÿæœºåç§° è‡ªå®šï¼Œä½ç½® é€‰æ‹©å‰è¿°æ–°å»ºçš„æ–‡ä»¶å¤¹

  > æ³¨æ„ï¼šæ­¤æ—¶ä¼šç»™å‡ºè­¦å‘Šï¼ˆ"æŒ‡å®šä½ç½®ä¼¼ä¹å·²åŒ…å«ç°æœ‰è™šæ‹Ÿæœº"ï¼‰ï¼Œç›´æ¥é€‰æ‹©ç»§ç»­å³å¯ã€‚

+ å¤„ç†å™¨æ•°é‡ï¼š1ï¼Œæ¯ä¸ªå¤„ç†å™¨çš„å†…æ ¸æ•°é‡ï¼š4

  > åªè¦æ»¡è¶³å¤„ç†å™¨æ•°é‡ä¹˜ä»¥å†…æ ¸æ•°é‡å°äºå®¿ä¸»æœºå¤„ç†å™¨å†…æ ¸æ€»æ•°éƒ½å¯ä»¥ã€‚

+ è®¾ç½®è™šæ‹Ÿæœºå†…å­˜ï¼š1024MB
+ ç½‘ç»œè¿æ¥ é€‰æ‹©ä¸ä½¿ç”¨ç½‘ç»œè¿æ¥
+ SCSIæ§åˆ¶å™¨ é€‰æ‹©LSI Logic
+ è™šæ‹Ÿç£ç›˜ç±»å‹ é€‰æ‹©SCSI
+ ç£ç›˜ é€‰æ‹©ä½¿ç”¨ç°æœ‰è™šæ‹Ÿç£ç›˜
+ ç°æœ‰ç£ç›˜æ–‡ä»¶ é€‰æ‹©å‰è¿°æ–°å»ºçš„æ–‡ä»¶å¤¹ä¸­çš„vmdkæ–‡ä»¶è·¯å¾„

  > æ­¤æ—¶ä¼šå¼¹çª—æç¤ºæ˜¯å¦å°†ç°æœ‰è™šæ‹Ÿç£ç›˜è½¬æ¢ä¸ºæ›´æ–°çš„æ ¼å¼ï¼Œé€‰æ‹©ä¿æŒç°æœ‰æ ¼å¼å³å¯ã€‚

+ é€‰æ‹©è‡ªå®šä¹‰ç¡¬ä»¶ï¼Œç§»é™¤ä»¥ä¸‹å‡ ä¸ªç¡¬ä»¶ï¼šæ–°CD/DVDï¼ŒUSBæ§åˆ¶å™¨ï¼Œå£°å¡ï¼Œæ‰“å°æœº
+ å®Œæˆåˆ›å»ºï¼ŒVMwareå·¦ä¾§çš„è™šæ‹Ÿæœºåˆ—è¡¨ä¼šå‡ºç°æ–°åˆ›å»ºçš„è™šæ‹Ÿæœº

*å¯é€‰æ“ä½œ*ï¼šåœ¨è™šæ‹Ÿæœºåˆ—è¡¨å³å‡»æ–°åˆ›å»ºçš„è™šæ‹Ÿæœºæ ‡ç­¾å¡ï¼Œé€‰æ‹© è®¾ç½®->é€‰é¡¹->é«˜çº§ï¼Œå‹¾é€‰ *ä¸ä¸ºå¯ç”¨äº† Hyper-V çš„ä¸»æœºå¯ç”¨ä¾§é€šé“ç¼“è§£*ã€‚ç¦ç”¨æµ‹é€šé“ç¼“è§£åå¯ä»¥æé«˜è™šæ‹Ÿæœºæ€§èƒ½ã€‚

## 2 æ­å»ºä»…ä½¿ç”¨lançš„æ—è·¯ç½‘å…³

è¯¥ç½‘ç»œç»“æ„çš„ä¼˜ç‚¹æ˜¯æ­å»ºæ–¹ä¾¿ï¼Œç½‘ç»œæ‹“æ‰‘ç»“æ„ç®€å•ã€‚ç¼ºç‚¹å¾ˆå¤šï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸ç¬¦åˆè§„èŒƒçš„**éå¯¹ç§°ç½‘ç»œç»“æ„**ï¼ˆæŒ‡ä¸Šè¡Œæµé‡å’Œä¸‹è¡Œæµé‡å¯èƒ½ä¸ä¼šç»è¿‡åŒä¸€è·¯å¾„ï¼‰ã€‚åœ¨è™šæ‹Ÿæœºå†…ä½¿ç”¨OpenWrtæ—¶ï¼Œåªæ¨èåœ¨å®¿ä¸»æœº**èƒ½å¤Ÿè¿æ¥ç½‘çº¿**çš„æƒ…å†µä¸‹é‡‡ç”¨è¿™ä¸ªç½‘ç»œç»“æ„ã€‚å¦‚æœå®¿ä¸»æœºåªèƒ½è¿æ¥æ— çº¿ç½‘ç»œï¼Œåˆ™æ¨èç›´æ¥è·³è½¬é˜…è¯»[ä¸‹ä¸€ä¸ª](#3-æ­å»ºlan-wanç»“æ„çš„è·¯ç”±)ç½‘ç»œç»“æ„ã€‚

> å½“å®¿ä¸»æœºåªèƒ½è¿æ¥æ— çº¿ç½‘ç»œæ—¶ï¼Œé‡‡ç”¨æ—è·¯ç½‘å…³ç»“æ„ä¼šå¯¼è‡´å®¿ä¸»æœºé€šä¿¡å’Œè™šæ‹Ÿæœºå†…çš„OpenWrté€šä¿¡å†²çªï¼Œä»è€Œä½¿å¾—å®¿ä¸»æœºæ— æ³•æ­£å¸¸ä¸Šç½‘ï¼Œå³ä½¿å°†OpenWrtçš„lanå£å¼€å¯NATä¹Ÿæ²¡æœ‰æ•ˆæœã€‚

### 2.1 è®¾ç½®VMwareçš„VMnet

è¿›å…¥VMwareåé€‰æ‹© ç¼–è¾‘->è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨->æ›´æ”¹è®¾ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰ï¼Œè¿›å…¥å¦‚ä¸‹å›¾æ‰€ç¤ºçš„VMnetè®¾ç½®ç•Œé¢ã€‚

![VMnetè®¾ç½®ç•Œé¢](./pics/OpenWrt/2.1.png)

è¯¥ç½‘ç»œç»“æ„åªéœ€è¦ç”¨åˆ°ä¸€ä¸ªVMnetå­ç½‘ã€‚æœ¬æ–‡ä½¿ç”¨çš„æ˜¯VMnet2ï¼Œè¿™é‡Œå°†å…¶è®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼ï¼Œæ¡¥æ¥ç½‘å¡é€‰é¡¹ç”±é»˜è®¤çš„è‡ªåŠ¨æ”¹ä¸ºç‰©ç†æœ‰çº¿ç½‘å¡ã€‚

### 2.2 è®¾ç½®è™šæ‹Ÿæœºç½‘å¡

åœ¨VMwareå·¦ä¾§çš„è™šæ‹Ÿæœºåˆ—è¡¨å³å‡»è™šæ‹Ÿæœºæ ‡ç­¾å¡ï¼Œé€‰æ‹© è®¾ç½®->ç¡¬ä»¶->æ·»åŠ ->ç½‘ç»œé€‚é…å™¨ã€‚

![æ·»åŠ è™šæ‹Ÿæœºç½‘å¡](./pics/OpenWrt/2.2.png)

å¦‚ä¸Šå›¾ï¼Œåœ¨å³ä¾§çš„ç½‘ç»œè¿æ¥éƒ¨åˆ†é€‰æ‹©è‡ªå®šä¹‰ï¼Œå¹¶é€‰æ‹©ä¹‹å‰è®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼çš„VMnetå­ç½‘ã€‚

### 2.3 è®¾ç½®OpenWrt

å¼€å¯è™šæ‹Ÿæœºï¼Œå¾…å…¶åŠ è½½ä¸€æ®µæ—¶é—´åæŒ‰å›è½¦é”®å°±è¿›å…¥è™šæ‹Ÿæœºçš„ä¸»ç•Œé¢äº†ã€‚

> æ³¨æ„ï¼šå¦‚æœè™šæ‹Ÿæœºç•Œé¢åœ¨VMwareä¸­æ˜¾ç¤ºå¾—ç‰¹åˆ«å°ï¼Œå°±é€‰æ‹© æŸ¥çœ‹->æ‹‰ä¼¸å®¢æˆ·æœº->ä¿æŒçºµæ¨ªæ¯”æ‹‰ä¼¸ã€‚

![è™šæ‹Ÿæœºä¸»ç•Œé¢](./pics/OpenWrt/2.3.png)

ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶éœ€è¦è®¾ç½®å¯†ç ã€‚è¾“å…¥`passwd`æŒ‡ä»¤æŒ‰ç…§æç¤ºè®¾ç½®å¯†ç ã€‚

> æ³¨æ„ï¼šOpenWrtè™šæ‹Ÿæœºå†…å¦‚æœè¦ä½¿ç”¨å°é”®ç›˜éœ€è¦å…ˆç”¨Numlocké”®è§£é”ã€‚

åœ¨è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œä¹‹å‰éœ€è¦å…ˆç¡®å®šå®¿ä¸»æœºçš„ipåœ°å€ã€‚æ‰“å¼€CMDå‘½ä»¤æç¤ºè¡Œï¼Œè¾“å…¥`ipconfig`æŒ‡ä»¤ï¼Œæ‰¾åˆ°ä¹‹å‰è®¾ç½®æ¡¥æ¥çš„ç‰©ç†æœ‰çº¿ç½‘å¡ï¼Œç¡®è®¤å…¶ipã€‚å¦‚ä¸‹å›¾ï¼Œæˆ‘çš„å®¿ä¸»æœºipåœ°å€æ˜¯`192.168.1.234/24`ï¼Œç½‘å…³ipåœ°å€æ˜¯`192.168.1.1`ã€‚

![ipåœ°å€](./pics/OpenWrt/2.4.png)

ä¸‹é¢éœ€è¦æ›´æ”¹OpenWrtçš„lanå£ipåœ°å€ã€‚åœ¨OpenWrtå†…è¾“å…¥`vim /etc/config/network`æŒ‡ä»¤è¿›å…¥vimç¼–è¾‘ç•Œé¢ã€‚

ä½¿ç”¨æ–¹å‘é”®ï¼ˆæˆ–`H` `J` `K` `L`é”®ï¼‰å°†å…‰æ ‡ç§»åŠ¨è‡³ä¸‹å›¾æ‰€ç¤ºå¤„ã€‚

![lanå£ipä¿®æ”¹](./pics/OpenWrt/2.5.png)

æŒ‰`I`é”®å³å¯å¼€å§‹è¾“å…¥å†…å®¹ï¼Œä¿®æ”¹ipåœ°å€ã€‚lanå£ipåœ°å€çš„å‰ä¸‰æ®µä¸å®¿ä¸»æœºipåœ°å€å‰ä¸‰æ®µä¿æŒä¸€è‡´ï¼Œæœ€åä¸€æ®µä»1è‡³254ä¹‹é—´é€‰æ‹©ä¸€ä¸ªä¸å®¿ä¸»æœºç½‘å…³æ‰€åœ¨å±€åŸŸç½‘å†…æ‰€æœ‰è®¾å¤‡ipåœ°å€æœ€åä¸€æ®µéƒ½ä¸åŒçš„æ•°å­—ï¼Œæœ¬æ–‡é€‰æ‹©çš„æ˜¯31ã€‚

ä¿®æ”¹å®Œæˆä¹‹åæŒ‰`Esc`é”®ï¼Œå†è¾“å…¥`:wq`åæŒ‰å›è½¦é”®ï¼Œè¿™æ ·å°±ä¿å­˜å¹¶é€€å‡ºäº†ã€‚

è¾“å…¥`reboot`æŒ‡ä»¤é‡å¯OpenWrtæ“ä½œç³»ç»Ÿï¼ˆæˆ–è¾“å…¥`service network restart`æŒ‡ä»¤é‡å¯ç½‘ç»œæœåŠ¡å³å¯ï¼‰ã€‚

### 2.4 è¿›å…¥LuCIä¸»ç•Œé¢

æ‰“å¼€å®¿ä¸»æœºæµè§ˆå™¨ï¼Œè¾“å…¥ä¹‹å‰è®¾ç½®çš„OpenWrt lanå£ipåœ°å€ï¼ˆæœ¬æ–‡æ˜¯`192.168.1.31`ï¼‰ã€‚

å¦‚æœçœ‹åˆ°ä»¥ä¸‹ç•Œé¢å°±è¯´æ˜ç¬¬ä¸€æ­¥æˆåŠŸäº†ğŸ‰

![LuCIç™»å½•ç•Œé¢](./pics/OpenWrt/2.6.png)

è¾“å…¥å¯†ç ç™»å½•ä»¥åï¼Œé€‰æ‹© Network->Interface->Editã€‚

![lanå£ç¼–è¾‘ç•Œé¢](./pics/OpenWrt/2.7.png)

ä¸‹é¢æ˜¯lanå£çš„é…ç½®ä¿®æ”¹å†…å®¹ï¼š

+ General Settings -> IPv4 gateway ä¿®æ”¹ä¸ºä¹‹å‰æŸ¥çœ‹åˆ°çš„å®¿ä¸»æœºç½‘å…³ipåœ°å€ï¼ˆå³ä¸»è·¯ç”±lanå£çš„ipåœ°å€ï¼‰
+ Advanced Settings:

  + Use custom DNS servers æ¨èæ·»åŠ ä¸¤ä¸ªè°·æ­ŒDNSæœåŠ¡å™¨ï¼Œåœ°å€ä¸º`8.8.8.8`ï¼Œ`8.8.4.4`ã€‚

    > è¿™é‡Œè®¾ç½®çš„DNSæœåŠ¡å™¨åœ°å€è´Ÿè´£æ‰€æœ‰è¿›å‡ºOpenWrt lanå£çš„åŸŸåè§£æå·¥ä½œã€‚åŒ…æ‹¬è§£æOpenWrtè‡ªèº«éœ€è¦è®¿é—®çš„åŸŸåï¼ˆæ¯”å¦‚æ‰§è¡Œ`opkg`æŒ‡ä»¤å®‰è£…å„ç§åŒ…æ—¶éœ€è¦ç”¨åˆ°ï¼‰ï¼Œä¹ŸåŒ…æ‹¬å¤„ç†å®¿ä¸»æœºå‘OpenWrtå‘é€çš„åŸŸåè§£æè¯·æ±‚ã€‚

  + IPv6 assignment length é€‰æ‹© disabledã€‚

    > è¿™æ ·å¯ä»¥ç¦ç”¨lanå£çš„IPv6åœ°å€ã€‚è‹¥æ— ä½¿ç”¨IPv6çš„ç‰¹æ®Šéœ€æ±‚éƒ½åº”å½“å…³é—­IPv6ï¼Œå› ä¸ºIPv6åœ¨é€æ˜ä»£ç†ä¸­ä¼šå¼•å…¥ä¸å¿…è¦çš„é—®é¢˜ã€‚ç¦ç”¨è¯¥é€‰é¡¹å General Settings é€‰é¡¹å¡ç•Œé¢ä¼šæ–°å‡ºç°IPv6åœ°å€å’Œç½‘å…³çš„è®¾ç½®é€‰é¡¹ï¼Œä¿æŒä¸ºç©ºå³å¯ã€‚

+ DHCP Server -> General Setup -> Ignore interface å‹¾é€‰è¯¥é¡¹ã€‚

  > è¿™æ ·å¯ä»¥å…³é—­OpenWrtçš„DHCPæœåŠ¡ï¼Œå°†æ‰€æœ‰DHCPæœåŠ¡äº¤ç»™ä¸»è·¯ç”±æ¥å®Œæˆã€‚å¦‚æœå…³é—­äº†ä¸»è·¯ç”±çš„DHCPæœåŠ¡ï¼Œåˆ™å¯ä»¥å¼€å¯OpenWrtçš„DHCPæœåŠ¡ï¼Œå³ä¸¤è€…åªèƒ½å¼€å¯å…¶ä¸­ä¸€ä¸ªã€‚
  >
  > å¦‚æœé€‰æ‹©ä½¿ç”¨OpenWrtçš„DHCPæœåŠ¡ï¼Œåˆ™è¿˜åº”å½“å…³é—­IPv6çš„ä¸‹å‘ï¼Œæ–¹æ³•æ˜¯é€‰æ‹© DHCP Server -> IPv6 Settingsï¼šRA-Service -> disabledï¼ŒDHCPv6-Service -> disabledï¼ŒNDP-Proxy -> disabledã€‚

æ­¤å¤–è¿˜æ¨èä¿®æ”¹ä¸€é¡¹é˜²ç«å¢™è®¾ç½®ã€‚é€‰æ‹© Network -> Firewallï¼Œå‹¾é€‰lanåŒºåŸŸçš„`Masq`é€‰é¡¹ã€‚

> åœ¨OpenWrté‡ŒMasqueradingç­‰æ•ˆäºNATã€‚è™½ç„¶ç»™lanå£å¼€å¯NATä¼šå½¢æˆç½‘ç»œç»“æ„é‡Œåº”å½“ç«­åŠ›é¿å…çš„*åŒé‡NAT*ï¼Œé€ æˆä¸€å®šçš„æ€§èƒ½æŸå¤±ï¼Œä½†æ˜¯å¯¹äºæ—è·¯ç½‘å…³è¿™ç§éå¯¹ç§°ç½‘ç»œç»“æ„æ¥è¯´å¼€å¯NATå¯ä»¥æ¨¡æ‹Ÿå‡ºå¯¹ç§°ç½‘ç»œç»“æ„ï¼Œä»è€Œé¿å…ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„ç–‘éš¾æ‚ç—‡ï¼Œæ€»çš„æ¥è¯´è‚¯å®šæ˜¯å¸¦æ¥çš„å¥½å¤„å¤§äºç¼ºç‚¹ï¼Œè¿™ä¹Ÿç®—æ˜¯ä¸å¾—å·²è€Œä¸ºä¹‹ã€‚

![lan Masquerading](./pics/OpenWrt/2.8.png)

### 2.5 ä½¿ç”¨OpenWrt

æ—è·¯ç½‘å…³ç»“æ„ä½¿ç”¨OpenWrtæ ¸å¿ƒæ˜¯è¦è®©ä¸Šç½‘è®¾å¤‡çš„ç½‘å…³å’ŒDNSæœåŠ¡å™¨åœ°å€æŒ‡å‘OpenWrtã€‚ä¸ºè¾¾åˆ°è¿™ä¸€ç›®çš„å¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•ï¼Œå…¶ä¸€æ˜¯åœ¨è®¾å¤‡è‡ªèº«ä¿®æ”¹ç½‘å…³å’ŒDNSæœåŠ¡å™¨åœ°å€ï¼Œå¦‚æœè®¾å¤‡æ— æ³•è®¾å®šè‡ªèº«ç½‘å…³ï¼ˆæ¯”å¦‚ç”µè§†ç›’å­ï¼‰ï¼Œå°±éœ€è¦ç”¨åˆ°å¦ä¸€ç§æ–¹æ³•ï¼Œå³ä¿®æ”¹ä¸»è·¯ç”±DHCPæœåŠ¡å™¨ä¸‹å‘çš„ç½‘å…³å’ŒDNSæœåŠ¡å™¨åœ°å€ã€‚

æ–¹æ³•ä¸€ï¼š

ä»¥Windowsç³»ç»Ÿä¸ºä¾‹ï¼Œé€‰æ‹©æœ‰çº¿ç½‘å¡çš„ä»¥å¤ªç½‘å±æ€§ï¼Œä¸ºå…¶è®¾å®šä¸€ä¸ªåˆé€‚çš„ipåœ°å€ï¼ˆè¿™é‡Œé€‰æ‹©çš„æ˜¯`192.168.1.32`ï¼‰ï¼Œå¹¶ä¿®æ”¹é»˜è®¤ç½‘å…³å’ŒDNSæœåŠ¡å™¨ä¸ºOpenWrtçš„lanå£åœ°å€ï¼ˆå³å‰æ–‡æ‰€è¿°çš„`192.168.1.31`ï¼‰ã€‚

![ä¿®æ”¹è®¾å¤‡ç½‘å…³å’ŒDNSæœåŠ¡å™¨](./pics/OpenWrt/2.9.png)

æ–¹æ³•äºŒï¼š

å„å“ç‰Œçš„è·¯ç”±å™¨è®¾ç½®æ–¹æ³•ä¸åŒï¼Œä»¥ç”µä¿¡å®½å¸¦èµ é€çš„WAT301è·¯ç”±å™¨ä¸ºä¾‹ï¼Œé€‰æ‹© è·¯ç”±è®¾ç½®->DHCPæœåŠ¡å™¨ï¼Œå³å¯ä¿®æ”¹DHCPæœåŠ¡å™¨ä¸‹å‘ç»™è®¾å¤‡çš„ç½‘å…³å’ŒDNSæœåŠ¡å™¨åœ°å€ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯è¿æ¥ä¸»è·¯ç”±çš„æ‰€æœ‰è®¾å¤‡éƒ½ä¼šå—åˆ°å½±å“ã€‚

![ä¿®æ”¹ä¸»è·¯ç”±ç½‘å…³å’ŒDNSæœåŠ¡å™¨](./pics/OpenWrt/2.10.png)

## 3 æ­å»ºlan-wanç»“æ„çš„è·¯ç”±

è¯¥ç»“æ„æ˜¯ä¸€ä¸ªç¬¦åˆè§„èŒƒçš„**å¯¹ç§°ç½‘ç»œç»“æ„**ã€‚æ¨èå°½é‡ä½¿ç”¨è¯¥ç»“æ„ã€‚å”¯ä¸€çš„ç¼ºç‚¹æ˜¯éœ€è¦è‡³å°‘åŒç½‘å¡ã€‚ä¸è¿‡æœ¬æ–‡æ˜¯åœ¨è™šæ‹Ÿæœºç¯å¢ƒä¸‹å®ç°ï¼ŒVMwareå¯ä»¥æ·»åŠ åä½™ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå› æ­¤è¿™ä¸ªç¼ºç‚¹ä¹Ÿå°±å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ç›¸è¾ƒäºä»…ä½¿ç”¨lançš„æ—è·¯ç½‘å…³ç»“æ„æ¥è¯´ï¼Œä½¿ç”¨lan-wanç»“æ„çš„è·¯ç”±æœ‰å¾ˆå¤šå¥½å¤„ï¼Œæœ€æ˜æ˜¾çš„å°±æ˜¯åœ¨æ— çº¿ç½‘ç»œç¯å¢ƒä¸‹ï¼Œå®¿ä¸»æœºä¹Ÿèƒ½ä½¿ç”¨è™šæ‹Ÿæœºé‡Œçš„OpenWrtæ¥æ­£å¸¸ä¸Šç½‘äº†ã€‚å› æ­¤ä¸‹æ–‡é‡‡ç”¨å®¿ä¸»æœºæ— çº¿ç½‘å¡ä½œä¸ºç»™è™šæ‹ŸæœºOpenWrtæä¾›ç½‘ç»œçš„ç‰©ç†è®¾å¤‡ã€‚

### 3.1 è®¾ç½®VMwareçš„VMnet

è¿›å…¥VMwareåé€‰æ‹© ç¼–è¾‘->è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨->æ›´æ”¹è®¾ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰ï¼Œè¿›å…¥å¦‚ä¸‹å›¾æ‰€ç¤ºçš„VMnetè®¾ç½®ç•Œé¢ã€‚

![VMnetè®¾ç½®ç•Œé¢](./pics/OpenWrt/3.1.png)

è¯¥ç½‘ç»œç»“æ„éœ€è¦ç”¨åˆ°ä¸¤ä¸ªVMnetå­ç½‘ï¼ˆé€‰æ‹© æ·»åŠ ç½‘ç»œ é€‰é¡¹ï¼Œå¯ä»¥æ·»åŠ VMnetå­ç½‘ï¼‰ï¼š

+ å°†VMnet0è®¾ç½®ä¸º**æ¡¥æ¥æ¨¡å¼**(*bridge*)ï¼Œæ¡¥æ¥ç½‘å¡é€‰é¡¹ç”±é»˜è®¤çš„è‡ªåŠ¨æ”¹ä¸ºç‰©ç†æ— çº¿ç½‘å¡ï¼ŒVMnet0å­ç½‘å°†ä½œä¸ºOpenWrtçš„wanå£åŒºåŸŸã€‚

+ å°†VMnet1è®¾ç½®ä¸º**ä»…ä¸»æœºæ¨¡å¼**(*host only*)ï¼ŒVMnet1å­ç½‘å°†ä½œä¸ºOpenWrtçš„lanå£åŒºåŸŸã€‚å°†VMnet1ç½‘å¡çš„DHCPæœåŠ¡é€‰é¡¹å…³é—­ï¼Œå› ä¸ºDHCPæœåŠ¡å°†äº¤ç»™OpenWrtçš„lanå£æ¥å®ç°ã€‚è®¾ç½®ä¸€ä¸ªåˆé€‚çš„å­ç½‘IPï¼Œæœ¬æ–‡å°†VMnet1å­ç½‘ç½‘æ®µè®¾ç½®ä¸º`192.168.10.0`ã€‚

### 3.2 è®¾ç½®è™šæ‹Ÿæœºç½‘å¡

åœ¨VMwareå·¦ä¾§çš„è™šæ‹Ÿæœºåˆ—è¡¨å³å‡»è™šæ‹Ÿæœºæ ‡ç­¾å¡ï¼Œé€‰æ‹© è®¾ç½®->ç¡¬ä»¶->æ·»åŠ ->ç½‘ç»œé€‚é…å™¨ã€‚

![æ·»åŠ è™šæ‹Ÿæœºç½‘å¡](./pics/OpenWrt/3.2.png)

å¦‚ä¸Šå›¾ï¼Œåœ¨å³ä¾§çš„ç½‘ç»œè¿æ¥éƒ¨åˆ†é€‰æ‹©è‡ªå®šä¹‰ï¼Œå¹¶é€‰æ‹©ä¹‹å‰è®¾ç½®ä¸ºä»…ä¸»æœºæ¨¡å¼çš„VMnet1å­ç½‘ã€‚

å†æ¬¡æ·»åŠ ç½‘ç»œé€‚é…å™¨ï¼Œå¹¶é€‰æ‹©ä¹‹å‰è®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼çš„VMnet0å­ç½‘ã€‚

> æ³¨æ„ï¼š**æ·»åŠ ç½‘ç»œé€‚é…å™¨çš„é¡ºåºä¸èƒ½é¢ å€’**ã€‚OpenWrté»˜è®¤eth1ä¸ºwanå£ï¼Œeth0(åŠeth2ï¼Œeth3...)ä¸ºlanå£ã€‚ç¬¬ä¸€ä¸ªæ·»åŠ çš„ç½‘ç»œé€‚é…å™¨ä¸ºeth0ï¼Œå¯¹åº”lanå£ï¼›ç¬¬äºŒä¸ªæ·»åŠ çš„ç½‘ç»œé€‚é…å™¨ä¸ºeth1ï¼Œå¯¹åº”wanå£ã€‚

### 3.3 è®¾ç½®OpenWrt

å¼€å¯è™šæ‹Ÿæœºï¼Œå¾…å…¶åŠ è½½ä¸€æ®µæ—¶é—´åæŒ‰å›è½¦é”®å°±è¿›å…¥è™šæ‹Ÿæœºçš„ä¸»ç•Œé¢äº†ã€‚

> æ³¨æ„ï¼šå¦‚æœè™šæ‹Ÿæœºç•Œé¢åœ¨VMwareä¸­æ˜¾ç¤ºå¾—ç‰¹åˆ«å°ï¼Œå°±é€‰æ‹© æŸ¥çœ‹->æ‹‰ä¼¸å®¢æˆ·æœº->ä¿æŒçºµæ¨ªæ¯”æ‹‰ä¼¸ã€‚

![è™šæ‹Ÿæœºä¸»ç•Œé¢](./pics/OpenWrt/3.3.png)

ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶éœ€è¦è®¾ç½®å¯†ç ã€‚è¾“å…¥`passwd`æŒ‡ä»¤æŒ‰ç…§æç¤ºè®¾ç½®å¯†ç ã€‚

> æ³¨æ„ï¼šOpenWrtè™šæ‹Ÿæœºå†…å¦‚æœè¦ä½¿ç”¨å°é”®ç›˜éœ€è¦å…ˆç”¨Numlocké”®è§£é”ã€‚

ä¸‹é¢éœ€è¦æ›´æ”¹OpenWrtçš„lanå£ipåœ°å€ã€‚åœ¨OpenWrtå†…è¾“å…¥`vim /etc/config/network`æŒ‡ä»¤è¿›å…¥vimç¼–è¾‘ç•Œé¢ã€‚

ä½¿ç”¨æ–¹å‘é”®ï¼ˆæˆ–`H` `J` `K` `L`é”®ï¼‰å°†å…‰æ ‡ç§»åŠ¨è‡³ä¸‹å›¾æ‰€ç¤ºå¤„ã€‚

![lanå£ipä¿®æ”¹](./pics/OpenWrt/3.4.png)

æŒ‰`I`é”®å³å¯å¼€å§‹è¾“å…¥å†…å®¹ï¼Œä¿®æ”¹ipåœ°å€ã€‚ç”±äºä¹‹å‰è®¾ç½®çš„VMnet1å­ç½‘ç½‘æ®µä¸º`192.168.10.0`ï¼Œå› æ­¤è¿™é‡Œå¯ä»¥å°†lanå£çš„ipè®¾ç½®ä¸º`192.168.10.1`ã€‚

ä¿®æ”¹å®Œæˆä¹‹åæŒ‰`Esc`é”®ï¼Œå†è¾“å…¥`:wq`åæŒ‰å›è½¦é”®ï¼Œè¿™æ ·å°±ä¿å­˜å¹¶é€€å‡ºäº†ã€‚

è¾“å…¥`reboot`æŒ‡ä»¤é‡å¯OpenWrtæ“ä½œç³»ç»Ÿï¼ˆæˆ–è¾“å…¥`service network restart`æŒ‡ä»¤é‡å¯ç½‘ç»œæœåŠ¡å³å¯ï¼‰ã€‚

ç”±äºOpenWrtçš„lanå£é»˜è®¤å¼€å¯äº†DHCPæœåŠ¡ï¼Œå› æ­¤å®¿ä¸»æœºçš„ *VMware Network Adapter VMnet1* ç½‘å¡æ­¤æ—¶åº”å½“è¢«åˆ†é…å¥½äº†ipåœ°å€å’Œç½‘å…³ã€‚å¦‚æœæ²¡æœ‰æ­£ç¡®åˆ†é…ï¼Œå°†è¯¥ç½‘å¡å…ˆç¦ç”¨å†å¯ç”¨å³å¯ã€‚

### 3.4 è¿›å…¥LuCIä¸»ç•Œé¢

æ‰“å¼€å®¿ä¸»æœºæµè§ˆå™¨ï¼Œè¾“å…¥ä¹‹å‰è®¾ç½®çš„OpenWrt lanå£ipåœ°å€ï¼ˆæœ¬æ–‡æ˜¯`192.168.10.1`ï¼‰ã€‚

å¦‚æœçœ‹åˆ°ä»¥ä¸‹ç•Œé¢å°±è¯´æ˜ç¬¬ä¸€æ­¥æˆåŠŸäº†ğŸ‰

![LuCIç™»å½•ç•Œé¢](./pics/OpenWrt/3.5.png)

è¾“å…¥å¯†ç ç™»å½•ä»¥åï¼Œé€‰æ‹© Network->Interfaceï¼Œç¼–è¾‘wanå£è®¾ç½®ã€‚

![wanå£ç¼–è¾‘ç•Œé¢](./pics/OpenWrt/3.6.png)

é€‰æ‹© Advanced Settingsï¼Œå–æ¶ˆå‹¾é€‰ Use DNS servers advertised by peer é€‰é¡¹ã€‚åœ¨å–æ¶ˆå‹¾é€‰åä¼šæ–°å‡ºç°ä¸€ä¸ª Use custom DNS servers é€‰é¡¹ã€‚æ¨èæ·»åŠ ä¸¤ä¸ªè°·æ­ŒDNSæœåŠ¡å™¨ï¼Œåœ°å€ä¸º`8.8.8.8`ï¼Œ`8.8.4.4`ã€‚

> è¿™é‡Œè®¾ç½®çš„DNSæœåŠ¡å™¨åœ°å€è´Ÿè´£æ‰€æœ‰è¿›å‡ºOpenWrt wanå£çš„åŸŸåè§£æå·¥ä½œã€‚åŒ…æ‹¬è§£æOpenWrtè‡ªèº«éœ€è¦è®¿é—®çš„åŸŸåï¼ˆæ¯”å¦‚æ‰§è¡Œ`opkg`æŒ‡ä»¤å®‰è£…å„ç§åŒ…æ—¶éœ€è¦ç”¨åˆ°ï¼‰ï¼Œä¹ŸåŒ…æ‹¬å¤„ç†å®¿ä¸»æœºå‘OpenWrtå‘é€çš„åŸŸåè§£æè¯·æ±‚ã€‚

![ä¿®æ”¹wanå£DNS](./pics/OpenWrt/3.7.png)

æ¥ä¸‹æ¥å»ºè®®ç¦ç”¨OpenWrtçš„IPv6åŠŸèƒ½ã€‚è‹¥æ— ä½¿ç”¨IPv6çš„ç‰¹æ®Šéœ€æ±‚éƒ½åº”å½“å…³é—­IPv6ï¼Œå› ä¸ºIPv6åœ¨é€æ˜ä»£ç†ä¸­ä¼šå¼•å…¥ä¸å¿…è¦çš„é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯éœ€è¦ä¿®æ”¹çš„è®¾ç½®ï¼š

+ é€‰æ‹© Network -> Interfaceï¼Œåˆ é™¤wan6æ¥å£ã€‚

+ é€‰æ‹© Network -> Interfaceï¼Œç¼–è¾‘lanæ¥å£ã€‚åœ¨lanæ¥å£çš„ç¼–è¾‘ç•Œé¢ï¼š

  + é€‰æ‹© DHCP Server -> IPv6 Settingsï¼šRA-Service -> disabledï¼ŒDHCPv6-Service -> disabledï¼ŒNDP-Proxy -> disabledã€‚

  + é€‰æ‹© Advanced Settingsï¼šIPv6 assignment length -> disabledã€‚

    > ç¦ç”¨è¯¥é€‰é¡¹å General Settings é€‰é¡¹å¡ç•Œé¢ä¼šæ–°å‡ºç°IPv6åœ°å€å’Œç½‘å…³çš„è®¾ç½®é€‰é¡¹ï¼Œä¿æŒä¸ºç©ºå³å¯ã€‚

+ é€‰æ‹© Network -> DHCP and DNS -> Filterï¼Œå‹¾é€‰ Filter IPv6 AAAA recordsã€‚

### 3.5 ä½¿ç”¨OpenWrt

ä¸ºäº†è®©OpenWrtæ¥ç®¡å®¿ä¸»æœºçš„ç½‘ç»œï¼Œä¸èƒ½ç®€å•åœ°ç¦ç”¨å®¿ä¸»æœºæ— çº¿ç½‘å¡ï¼ˆå› ä¸ºå®¿ä¸»æœºçš„æ— çº¿ç½‘å¡éœ€è¦ç»™OpenWrtçš„wanå£æä¾›ç½‘ç»œï¼‰ã€‚éœ€è¦ä¿®æ”¹å®¿ä¸»æœºæ— çº¿ç½‘å¡çš„ä»¥å¤ªç½‘å±æ€§ã€‚æœ‰ä¸¤ç§ä¿®æ”¹æ–¹å¼ï¼š

1. å–æ¶ˆIPv4å’ŒIPv6åè®®ã€‚
2. ä¿®æ”¹æ¥å£è·ƒç‚¹æ•°ï¼Œå°†å…¶æŒ‡å®šä¸ºä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ã€‚

è¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯é¿å…å®¿ä¸»æœºç½‘å¡ç›´æ¥äº§ç”Ÿç½‘ç»œé€šä¿¡ï¼ŒæŠŠç½‘ç»œé€šä¿¡çš„åŠŸèƒ½äº¤ç»™è™šæ‹Ÿæœºç½‘å¡ *VMware Network Adapter VMnet1*ã€‚

![ä¿®æ”¹å®¿ä¸»æœºæ— çº¿ç½‘å¡ä»¥å¤ªç½‘å±æ€§](./pics/OpenWrt/3.8.png)

æ–¹æ³•ä¸€æœ€ç¨³å¦¥ï¼Œä¸€å®šèƒ½è®©å®¿ä¸»æœºæ— çº¿ç½‘å¡æ— æ³•ç½‘ç»œé€šä¿¡ï¼Œä½†æ˜¯æœ‰ä¸ªç¼ºç‚¹æ˜¯ç³»ç»Ÿé‡Œçš„ç½‘ç»œè¿æ¥çŠ¶æ€ä¼šæ˜¾ç¤ºä¸ºæ— è¿æ¥ï¼Œæ— æ³•ä½¿ç”¨UWPåº”ç”¨å’ŒWindowså•†åº—ã€‚æ–¹æ³•äºŒåªæ˜¯æŠŠå®¿ä¸»æœºæ— çº¿ç½‘å¡çš„ä½¿ç”¨ä¼˜å…ˆçº§é™å¾—å¾ˆä½ï¼Œåœ¨OpenWrtå·¥ä½œå¤±æ•ˆçš„æ—¶å€™ä»ä¼šé‡‡ç”¨å®¿ä¸»æœºæ— çº¿ç½‘å¡è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œæ¯”è¾ƒä¸ä¿é™©ï¼Œä½†æ˜¯è¿™æ ·ä¸ä¼šè®©ç³»ç»Ÿç½‘ç»œè¿æ¥çŠ¶æ€æ˜¾ç¤ºä¸ºæ— è¿æ¥ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨UWPåº”ç”¨ã€‚å…·ä½“é‡‡ç”¨å“ªç§æ–¹å¼æ ¹æ®ä½¿ç”¨æƒ…å†µè¿›è¡Œæƒè¡¡ã€‚

### 3.6 **\*** å°†è™šæ‹Ÿæœºå†…çš„OpenWrtæä¾›ç»™å…¶ä»–è®¾å¤‡ä½¿ç”¨

å¦‚æœç”µè„‘åŒæ—¶æœ‰æœ‰çº¿ç½‘å¡å’Œæ— çº¿ç½‘å¡ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ— çº¿ç½‘å¡ç”¨æ¥ç»™OpenWrtçš„wanå£æä¾›ç½‘ç»œï¼Œæœ‰çº¿ç½‘å¡ç”¨æ¥æ¡¥æ¥OpenWrtçš„lanå£ï¼Œè¿™æ ·å°†ä¸€ä¸ªé—²ç½®è·¯ç”±å™¨å’Œç”µè„‘çš„æœ‰çº¿ç½‘å¡ç”¨ç½‘çº¿è¿æ¥ä¹‹åï¼Œè¿æ¥è¯¥è·¯ç”±å™¨çš„è®¾å¤‡ä¹Ÿå¯ä»¥ä½¿ç”¨OpenWrtçš„ç½‘ç»œã€‚

å†æ¬¡æ‰“å¼€è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ï¼Œæ·»åŠ ä¸€ä¸ªæ¡¥æ¥ç‰©ç†æœ‰çº¿ç½‘å¡çš„VMnetå­ç½‘ã€‚æœ¬æ–‡è®¾ç½®çš„æ˜¯VMnet2å­ç½‘ã€‚

![VMnetå­ç½‘è®¾ç½®](./pics/OpenWrt/3.9.png)

ç»™OpenWrtè™šæ‹Ÿæœºæ–°æ·»åŠ ä¸€ä¸ªç½‘ç»œé€‚é…å™¨ï¼Œå¹¶é€‰æ‹©ä¹‹å‰è®¾ç½®ä¸ºæ¡¥æ¥ç‰©ç†æœ‰çº¿ç½‘å¡çš„VMnet2å­ç½‘ã€‚ï¼ˆå¯ä»¥åœ¨OpenWrtæ­£åœ¨è¿è¡Œçš„æ—¶å€™æ·»åŠ ç½‘ç»œé€‚é…å™¨ã€‚å½“OpenWrtæ£€æµ‹åˆ°æœ‰æ–°çš„ç½‘å¡æ¥å…¥æ—¶ä¼šè‡ªåŠ¨é‡å¯ç½‘ç»œæœåŠ¡ï¼Œå³ç­‰æ•ˆäºè‡ªåŠ¨æ‰§è¡Œ`service network restart`æŒ‡ä»¤ï¼‰

åœ¨æ·»åŠ ç½‘ç»œé€‚é…å™¨åé‡æ–°è¿›å…¥OpenWrtçš„LuCIè®¾ç½®ç•Œé¢ã€‚é€‰æ‹© Network -> Interface -> Devicesï¼Œè¿›å…¥br-lançš„è®¾ç½®ç•Œé¢ã€‚

![æ¡¥æ¥ç½‘å£1](./pics/OpenWrt/3.10.png)

br-lanæ˜¯ä¸€ä¸ªæŠ½è±¡å‡ºæ¥çš„æ¡¥æ¥lanå£ï¼Œæ‰€æœ‰æ–°æ·»åŠ çš„lanå£ç½‘å¡éƒ½åº”å½“åŠ å…¥br-lançš„æ¡¥æ¥è®¾ç½®ä¸­ã€‚åœ¨ General device options é€‰é¡¹å¡ä¸‹æ‰¾åˆ° Bridge portsï¼Œå‹¾é€‰æ–°æ·»åŠ çš„eth2ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠåŸæœ¬çš„eth0å’Œæ–°æ·»åŠ çš„eth2æ¡¥æ¥èµ·æ¥ï¼Œå®ƒä»¬å…±ç”¨br-lanè¿™ä¸ªæŠ½è±¡æ¥å£ã€‚

![æ¡¥æ¥ç½‘å£2](./pics/OpenWrt/3.11.png)

æ¥ä¸‹æ¥éœ€è¦è®¾ç½®è·¯ç”±å™¨ï¼Œéœ€è¦å°†è·¯ç”±å™¨ä»**è·¯ç”±æ¨¡å¼**æ”¹ä¸º**APæ¨¡å¼**ã€‚å„å“ç‰Œçš„è·¯ç”±å™¨è®¾ç½®æ–¹æ³•ä¸åŒï¼Œä»¥ç”µä¿¡å®½å¸¦èµ é€çš„WAT301è·¯ç”±å™¨ä¸ºä¾‹ï¼Œåªéœ€è¦å…³é—­lanå£DHCPæœåŠ¡å°±èƒ½å°†è·¯ç”±å™¨æ”¹ä¸ºAPæ¨¡å¼ï¼Œæ­¤æ—¶è·¯ç”±å™¨çš„å››ä¸ªç½‘å£å…¨éƒ¨å˜æˆlanå£ã€‚ï¼ˆæ³¨æ„å¦‚æœè·¯ç”±å™¨çš„lanå£ipä¸æ˜¯è‡ªåŠ¨è·å–çš„çŠ¶æ€ï¼Œè¿˜éœ€è¦å†æ‰‹åŠ¨ä¿®æ”¹å…¶ipåœ°å€ï¼Œé¿å…ä¸OpenWrtçš„lanå£ipå†²çªï¼‰

![è·¯ç”±å™¨APæ¨¡å¼](./pics/OpenWrt/3.12.png)

ç°åœ¨å°†è·¯ç”±å™¨å’Œç”µè„‘çš„æœ‰çº¿ç½‘å¡ç”¨ç½‘çº¿è¿æ¥èµ·æ¥ï¼Œæ­¤æ—¶è¿æ¥è¯¥è·¯ç”±å™¨çš„æ‰€æœ‰è®¾å¤‡éƒ½å¯ä»¥ä½¿ç”¨OpenWrtçš„ç½‘ç»œäº†ã€‚

## 4 é™„å½•

### 4.1 ç›´æ¥ä½¿ç”¨.imgæ–‡ä»¶å®‰è£…ç³»ç»Ÿçš„æ–¹æ³•

ç›´æ¥ä½¿ç”¨`.img`æ ¼å¼çš„æ˜ åƒæ–‡ä»¶æ¥å®‰è£…ç³»ç»Ÿï¼Œç›¸è¾ƒäº [1.2èŠ‚](#12-è½¬æ¢openwrtå›ºä»¶æ ¼å¼) æ‰€è¿°ä½¿ç”¨è½¬æ¢è½¯ä»¶å°†å…¶è½¬æ¢æˆè™šæ‹Ÿæœºç£ç›˜æ ¼å¼`.vmdk`æ–‡ä»¶ä¹‹åå†ä½¿ç”¨çš„æ–¹æ³•æ¥è¯´æ¯”è¾ƒç¹çï¼Œä½†æ˜¯å¦‚æœæƒ³è¦å°†OpenWrtå®‰è£…åˆ°å®é™…çš„ç¡¬ä»¶ç¯å¢ƒä¸Šåªèƒ½ä½¿ç”¨`.img`æ ¼å¼çš„æ˜ åƒæ–‡ä»¶ï¼Œç”¨è™šæ‹Ÿæœºæ¨¡æ‹Ÿä¸€éæœ‰åŠ©äºå¢å¼ºç†è§£ã€‚

#### 4.1.1 å°†.imgæ–‡ä»¶çƒ§å½•å…¥Uç›˜

é¦–å…ˆéœ€è¦å°†`.img`æ˜ åƒæ–‡ä»¶çƒ§å½•å…¥Uç›˜ä¸­ï¼Œç”¨åˆ°è½¯ä»¶balenaEtcherã€‚ï¼ˆçƒ§å½•æ—¶ä¼šæ ¼å¼åŒ–Uç›˜ï¼ŒåŸæ¥çš„æ‰€æœ‰å‚¨å­˜ä¿¡æ¯éƒ½ä¼šä¸¢å¤±ï¼‰

[Etcherä¸‹è½½åœ°å€](https://etcher.balena.io/#download-etcher "https://etcher.balena.io/#download-etcher")

é€‰æ‹© Flash from file é€‰é¡¹å¼€å§‹çƒ§å½•ã€‚

![Etcherç•Œé¢](./pics/OpenWrt/4.1.png)

å®Œæˆçƒ§å½•åä¼šå‡ºç°å¾ˆå¤šå¼¹çª—ï¼Œæç¤ºéœ€è¦æ ¼å¼åŒ–Uç›˜ï¼Œç›´æ¥å…³é—­è¿™äº›å¼¹çª—ï¼Œå¯ä»¥å‘ç°åŸæ¥çš„Uç›˜å›¾æ ‡å˜æˆäº†ä¸€ä¸ªåå« Removeable Disk çš„ç›˜ç¬¦ã€‚

ç°åœ¨å°†Uç›˜æ‹”ä¸‹å¹¶é‡æ–°è¿æ¥è‡³ç”µè„‘ï¼Œæ­¤æ—¶å¯ä»¥çœ‹è§å¤šäº†ä¸‰ä¸ªç›˜ç¬¦ï¼Œå…¶ä¸­ä¸¤ä¸ªç›˜ç¬¦åŒå‡»åæç¤ºéœ€è¦æ ¼å¼åŒ–ï¼Œå¦ä¸€ä¸ªåå« kernel çš„ç›˜ç¬¦å¯ä»¥ç›´æ¥åŒå‡»æ‰“å¼€ï¼Œé‡Œé¢æœ‰efiæ–‡ä»¶ã€‚è¿™æ ·è¡¨ç¤ºçƒ§å½•æˆåŠŸã€‚

![æ–°ç›˜ç¬¦](./pics/OpenWrt/4.2.png)

> çƒ§å½•åçš„Uç›˜æ¢å¤ä¸ºæ™®é€šUç›˜çš„æ­¥éª¤ï¼š
>
> + CMDè¾“å…¥`diskpart`æŒ‡ä»¤ï¼Œè¿›å…¥åˆ°diskpart.exeç•Œé¢
> + è¾“å…¥`list disk`æŒ‡ä»¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰ç£ç›˜ï¼Œä¾æ®ç£ç›˜å®¹é‡ç¡®å®šUç›˜çš„ç£ç›˜ç¼–å·ï¼Œæ ¼å¼ä¸º`Disk NUM`ï¼Œå…¶ä¸­`NUM`æ˜¯å…·ä½“çš„ç¼–å·ã€‚
> + è¾“å…¥`select disk NUM`æŒ‡ä»¤ï¼Œå…¶ä¸­`NUM`éœ€è¦æ›¿æ¢ä¸ºå…·ä½“çš„ç£ç›˜ç¼–å·ã€‚å†æ¬¡è¾“å…¥`list disk`æŒ‡ä»¤ï¼Œè¢«é€‰ä¸­çš„ç£ç›˜å‰é¢æœ‰`*`å·ã€‚
> + è¾“å…¥`clean`æŒ‡ä»¤ï¼Œæ¸…é™¤ç£ç›˜åˆ†åŒºã€‚ï¼ˆæ­¤æ—¶å¯èƒ½ä¼šæœ‰å¼¹çª—æç¤º *Please insert a disk into USB Drive*ï¼Œå…³é—­è¯¥å¼¹çª—å³å¯ï¼‰
> + è¾“å…¥`create partition primary`æŒ‡ä»¤ï¼Œæ­¤æ—¶ä¼šå¼¹çª—æç¤ºéœ€è¦æ ¼å¼åŒ–Uç›˜ï¼Œè‹¥æœªå¼¹çª—æ‰‹åŠ¨åŒå‡»Uç›˜å›¾æ ‡ä¹Ÿå¯ã€‚
> + æ ¼å¼åŒ–Uç›˜æ—¶æ‰€æœ‰é€‰é¡¹ä¿æŒé»˜è®¤å³å¯ï¼Œæ ¼å¼åŒ–å®Œæ¯•ä¹‹åå°±èƒ½æ­£å¸¸ä½¿ç”¨äº†ã€‚

#### 4.1.2 VMwareè™šæ‹Ÿæœºé…ç½®

ä»¥**ç®¡ç†å‘˜æ¨¡å¼**è¿è¡ŒVMwareã€‚åˆ›å»ºæ–°è™šæ‹Ÿæœºçš„æ­¥éª¤ä¸ [1.4èŠ‚](#14-å®‰è£…è™šæ‹Ÿæœº) ç›¸åŒï¼Œåˆ°äº† *é€‰æ‹©ç£ç›˜* ç•Œé¢çš„æ—¶å€™ï¼Œé€‰æ‹©ç¬¬ä¸‰é¡¹ï¼šä½¿ç”¨ç‰©ç†ç£ç›˜ã€‚é€‰æ‹©ç‰©ç†ç£ç›˜è®¾å¤‡æ—¶ï¼Œå†æ¬¡ä½¿ç”¨`diskpart`->`list disk`ï¼Œä¾æ®ç£ç›˜å®¹é‡ç¡®å®šUç›˜çš„ PhysicalDrive ç¼–å·ã€‚ä¸‹é¢çš„ *ä½¿ç”¨æƒ…å†µ* é€‰é¡¹é€‰æ‹©ä½¿ç”¨æ•´ä¸ªç£ç›˜ã€‚

![ç‰©ç†ç£ç›˜é€‰æ‹©](./pics/OpenWrt/4.3.png)

é€‰æ‹©å®Œç‰©ç†ç£ç›˜åæŒ‰æç¤ºåˆ›å»ºä¸€ä¸ª`.vmdk`æ ¼å¼çš„ç£ç›˜æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†å‚¨å­˜Uç›˜çš„åˆ†åŒºä¿¡æ¯ã€‚

æœ€åè¿›å…¥è‡ªå®šä¹‰ç¡¬ä»¶ç•Œé¢ï¼Œç§»é™¤ä¸å¿…è¦çš„ç¡¬ä»¶ï¼Œç„¶åæ·»åŠ ä¸€ä¸ªæ¡¥æ¥ä¸»ç½‘å¡çš„ç½‘ç»œé€‚é…å™¨ï¼Œå®Œæˆè™šæ‹Ÿæœºåˆ›å»ºã€‚

åœ¨å®Œæˆè™šæ‹Ÿæœºåˆ›å»ºåï¼Œä»VMwareå·¦ä¾§çš„è™šæ‹Ÿæœºåˆ—è¡¨æ‰¾åˆ°è¯¥è™šæ‹Ÿæœºé€‰é¡¹å¡ï¼Œå³å‡»é€‰æ‹©ï¼šè®¾ç½®->æ·»åŠ ->ç¡¬ç›˜->SCSI->åˆ›å»ºæ–°è™šæ‹Ÿç£ç›˜ã€‚åœ¨åˆ›å»ºç£ç›˜æ—¶è®¾ç½®ä¸€ä¸ªåˆé€‚çš„ç£ç›˜å¤§å°ï¼Œæ­¤å¤„é€‰æ‹©è®¾ç½®ä¸º2GBã€‚è¿™æ ·ä¼šæ–°ç”Ÿæˆä¸€ä¸ª`.vmdk`ç£ç›˜æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ç”¨æ¥å‚¨å­˜é¢„å¤‡ä»Uç›˜è½¬ç§»çš„ç³»ç»Ÿã€‚

#### 4.1.3 å¯åŠ¨ç³»ç»Ÿ

å‡†å¤‡è¿è¡Œè™šæ‹Ÿæœºæ—¶ï¼Œå³å‡»è™šæ‹Ÿæœºé€‰é¡¹å¡ï¼Œé€‰æ‹©ï¼šç”µæº->æ‰“å¼€ç”µæºæ—¶è¿›å…¥å›ºä»¶ã€‚è¿™æ ·å¼€æœºå¯åŠ¨æ—¶ä¼šç›´æ¥è¿›å…¥BIOSç•Œé¢ã€‚

åœ¨BIOSä¸»ç•Œé¢ä½¿ç”¨æ–¹å‘é”®åˆ‡æ¢è‡³ Boot é€‰é¡¹å¡ã€‚

![BIOSç•Œé¢å¯åŠ¨ä¼˜å…ˆçº§](./pics/OpenWrt/4.1.3_1.png)

ç„¶åä¾æ®ç•Œé¢ä¸Šçš„æ“ä½œæç¤ºä½¿ç”¨æ–¹å‘é”®å’Œ`+`ã€`-`é”®è°ƒæ•´å„å¯åŠ¨é¡¹ä¼˜å…ˆçº§ï¼Œéœ€è¦ç¡®ä¿Uç›˜å¯åŠ¨ä¼˜å…ˆçº§æ¯”å½“å‰ä¸ºç©ºçš„æœ¬åœ°ç£ç›˜å¯åŠ¨ä¼˜å…ˆçº§é«˜ä¸€çº§ï¼Œå¦åˆ™ä¼šæ— æ³•è¿›å…¥Uç›˜ä¸­çš„ç³»ç»Ÿã€‚

è°ƒæ•´å®Œå¯åŠ¨ä¼˜å…ˆçº§ååˆ‡æ¢è‡³ Exit é€‰é¡¹å¡ï¼Œé€‰æ‹© Exit Saving Changesã€‚æ­¤æ—¶å°±è¿›å…¥Uç›˜ä¸­çš„ç³»ç»Ÿå¯åŠ¨ç¯èŠ‚ã€‚

#### 4.1.4 è½¬ç§»ç³»ç»Ÿ

ä½¿ç”¨`vim /ect/config/network`æŒ‡ä»¤ç¼–è¾‘eth0çš„IPåœ°å€ï¼Œä½¿å…¶ä¸ä¸å½“å‰ç½‘ç»œç¯å¢ƒä¸­çš„æŸä¸ªIPåœ°å€å†²çªã€‚ä¿®æ”¹å®Œåä½¿ç”¨`service network restart`æŒ‡ä»¤é‡å¯ç½‘ç»œæœåŠ¡ã€‚æ³¨æ„å½“å‰åœ¨è¿™ä¸ªç³»ç»Ÿä¸­åšçš„æ‰€æœ‰è®¾ç½®éƒ½ä¼šä¿å­˜åœ¨Uç›˜ä¸­ï¼Œæ¯”å¦‚é…ç½®çš„ç³»ç»Ÿå¯†ç ã€æ¥å£å’Œé˜²ç«å¢™è®¾ç½®ç­‰ï¼Œéƒ½ä¸ä¼šå‚¨å­˜åœ¨`.vmdk`æ ¼å¼çš„æœ¬åœ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚å› æ­¤éœ€è¦å°†Uç›˜ä¸­çš„ç³»ç»Ÿå®Œæ•´è½¬ç§»è‡³æœ¬åœ°æ–‡ä»¶ã€‚

åœ¨å®¿ä¸»æœºé‡Œé¢æ‰“å¼€CMDæ§åˆ¶å°ï¼Œä½¿ç”¨`scp`æŒ‡ä»¤å°†`.img`æ˜ åƒæ–‡ä»¶ä¸Šä¼ è‡³OpenWrtçš„`/tmp/`æ–‡ä»¶å¤¹ä¸‹ã€‚æŒ‡ä»¤æ ¼å¼æ˜¯`scp LOCAL_FILE_PATH REMOTE_HOST_NAME@IP:DEST_PATH`ã€‚

> ä¸Šè¿°æŒ‡ä»¤ä¸­`LOCAL_FILE_PATH`æ˜¯éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œ`REMOTE_HOST_NAME`æ˜¯è¿œç¨‹ä¸»æœºçš„ç”¨æˆ·åï¼Œæ­¤å¤„å®é™…ä¸º`root`ï¼Œ`IP`æ˜¯ä¹‹å‰ä¿®æ”¹çš„eth0çš„IPåœ°å€ï¼Œ`DEST_PATH`æ˜¯ä¸Šä¼ çš„ç›®çš„è·¯å¾„ï¼Œæ­¤å¤„å®é™…ä¸º`/tmp/`ã€‚
>
> å¦‚æœä½¿ç”¨`scp`æŒ‡ä»¤æŠ¥é”™`ash: /usr/libexec/sftp-server: not found`ï¼Œè¯´æ˜å®¿ä¸»æœºçš„ scp ç‰ˆæœ¬å¤ªæ–°ï¼Œåœ¨åº•å±‚ä½¿ç”¨çš„æ˜¯ sftp ä½œä¸ºåè®®ã€‚æ­¤æ—¶åŠ ä¸Š`-O`(**Old**)é€‰é¡¹å³å¯ã€‚å³`scp -O LOCAL_FILE_PATH REMOTE_HOST_NAME@IP:DEST_PATH`ã€‚æˆ–æ˜¯æ‰§è¡Œ`opkg update && opkg install openssh-sftp-server`ï¼Œä¸ºå…¶å®‰è£…ä¸Š sftp æœåŠ¡å™¨ã€‚

ä½¿ç”¨`dd`æŒ‡ä»¤è¿›è¡Œå†™ç›˜æ“ä½œã€‚æŒ‡ä»¤æ ¼å¼æ˜¯`dd if=INPUT_FILES of=OUTPUT_FILES`ã€‚æ‰§è¡Œå®Œ`dd`æŒ‡ä»¤åï¼Œéœ€å†æ‰§è¡Œ`sync`æŒ‡ä»¤ï¼Œç¡®ä¿å†…æ ¸ç¼“å†²åŒºä¸­æ‰€æœ‰æœªå†™å…¥ç£ç›˜çš„æ•°æ®å®Œæ•´å†™å…¥ç£ç›˜ã€‚

> ä¸Šè¿°æŒ‡ä»¤ä¸­`INPUT_FILES`æ˜¯è¾“å…¥æ–‡ä»¶è·¯å¾„ï¼Œæ­¤å¤„å®é™…ä¸ºä¹‹å‰é€šè¿‡`scp`æŒ‡ä»¤ä¸Šä¼ çš„`.img`æ˜ åƒæ–‡ä»¶å®Œæ•´è·¯å¾„ï¼Œ`OUTPUT_FILES`æ˜¯è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼Œæ­¤å¤„å®é™…ä¸ºä¹‹å‰æ–°åˆ›å»ºçš„`.vmdk`ç£ç›˜æ–‡ä»¶åœ¨OpenWrtç³»ç»Ÿä¸­å¯¹åº”çš„è®¾å¤‡åç§°ï¼Œåœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯`/dev/sdb`ã€‚
>
> ä¿é™©èµ·è§éœ€è¦ç”¨åˆ°`fdisk`æŒ‡ä»¤æŸ¥çœ‹è®¾å¤‡åç§°ã€‚ä½†æ˜¯OpenWrtä¸èƒ½åŸç”Ÿæ”¯æŒ`fdisk`æŒ‡ä»¤ï¼Œéœ€è¦å†ä¸ºOpenWrtè®¾å®šç½‘å…³å’ŒDNSä½¿å…¶èƒ½è®¿é—®å¤–éƒ¨ç½‘ç»œï¼ˆæ³¨æ„è¿˜è¦å…³é—­lanå£çš„dhcpæœåŠ¡ï¼‰ï¼Œå†ä½¿ç”¨`opkg update && opkg install fdisk`æŒ‡ä»¤ï¼Œè¿™æ ·å°±å¯ä»¥å®‰è£…`fdisk`ã€‚
>
> ä½¿ç”¨`fdisk -l`æŒ‡ä»¤ï¼ŒæŸ¥çœ‹è®¾å¤‡åç§°ã€‚å¯ä»¥ä¾æ®ç£ç›˜å®¹é‡æ¥åŒºåˆ†éœ€è¦ç”¨ä½œè¾“å…¥å’Œè¾“å‡ºçš„è™šæ‹Ÿç£ç›˜ã€‚
>
> ![ç¡®å®šè®¾å¤‡åç§°](./pics/OpenWrt/4.6.png)
>
> ç”±ä¸Šå›¾çš„ç»“æœï¼Œè¾“å…¥æŒ‡ä»¤`dd if=/tmp/OpenWrt.img of=/dev/sdb`ã€‚ï¼ˆ`OpenWrt.img`éœ€è¦æ¢æˆå®é™…çš„æ–‡ä»¶åç§°ï¼‰

å¾…çœ‹åˆ°`xxx records in`ï¼Œ`xxx records out`çš„æç¤ºåè¡¨ç¤ºOpenWrtç³»ç»Ÿå·²ä»`.img`æ˜ åƒæ–‡ä»¶å¤åˆ¶è‡³ååˆ›å»ºçš„`.vmdk`æœ¬åœ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨`poweroff`æŒ‡ä»¤å…³é—­ç³»ç»Ÿå¹¶æ‹”æ‰Uç›˜ã€‚

è¿›å…¥è™šæ‹Ÿæœºè®¾ç½®ç•Œé¢ï¼Œç§»é™¤Uç›˜å¯¹åº”çš„ç¡¬ä»¶è®¾å¤‡ï¼ˆç‚¹é€‰æ—¶ä¼šæç¤º *ç³»ç»Ÿæ‰¾ä¸åˆ°æŒ‡å®šçš„æ–‡ä»¶*ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»æ‹”æ‰Uç›˜ï¼Œç›´æ¥å…³é—­è¯¥æç¤ºå³å¯ï¼‰ã€‚

æ­¤æ—¶é‡æ–°è¿›å…¥çš„ç³»ç»Ÿå³æ˜¯ä»`.img`æ˜ åƒæ–‡ä»¶å®Œæ•´å¤åˆ¶è€Œæ¥çš„çº¯å‡€ç³»ç»Ÿï¼Œéœ€è¦å†é‡æ–°é…ç½®eth0çš„IPåœ°å€åæ–¹å¯é€šè¿‡è¯¥IPç™»å½•OpenWrtç³»ç»Ÿçš„luciç•Œé¢ï¼Œä»è€Œç»§ç»­è¿›è¡Œåç»­çš„é…ç½®å·¥ä½œã€‚

#### 4.1.5 ç³»ç»Ÿæ‰©å®¹

åœ¨ luci web ç•Œé¢ä»¥åŠä½¿ç”¨`fdisk -l`æŒ‡ä»¤å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰ OpenWrt ç³»ç»Ÿå¯ä½¿ç”¨çš„ç£ç›˜å‚¨å­˜ç©ºé—´çº¦ä¸º100Mï¼Œè¿œä¸åŠ[4.1.2èŠ‚](#412-vmwareè™šæ‹Ÿæœºé…ç½®)åˆ›å»ºç¡¬ç›˜2æ—¶è®¾å®šçš„2GBï¼Œè¿™æ˜¯å› ä¸º OpenWrt é•œåƒé»˜è®¤åˆ†åŒºå¸ƒå±€æœªåˆ©ç”¨å…¨éƒ¨ç£ç›˜ç©ºé—´ï¼Œéœ€è¦æŒ‰éœ€æ‰‹åŠ¨æ‰©å®¹ã€‚

![OPåˆå§‹å®¹é‡](./pics/OpenWrt/4.1.5_1.png)

ç”±äºéœ€è¦æ‰©å®¹çš„åˆ†åŒºä¸ºå·²æŒ‚è½½çš„æ ¹åˆ†åŒºï¼Œå› æ­¤é‡‡ç”¨ç¦»çº¿æ‰©å®¹çš„æ–¹å¼ã€‚

é‡æ–°ç»™è™šæ‹Ÿæœºæ·»åŠ ç¡¬ç›˜ï¼Œè®¾ç½®ä¹‹å‰çš„Uç›˜ä¸ºç¡¬ç›˜2ã€‚é€‰æ‹©ï¼šç”µæº->æ‰“å¼€ç”µæºæ—¶è¿›å…¥å›ºä»¶ï¼Œä¿®æ”¹ BIOS é‡Œçš„å¯åŠ¨ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆå¯åŠ¨Uç›˜ä¸­çš„ç³»ç»Ÿã€‚

> æ³¨ï¼šå½“å‰ç‰ˆæœ¬ä¸‹æ›´æ”¹è™šæ‹Ÿæœº BIOS ä¸­çš„å¯åŠ¨ä¼˜å…ˆçº§å¹¶ä¸èƒ½å®Œå…¨ç¡®ä¿ VMware æŒ‰ç…§æŒ‡å®šçš„ä¼˜å…ˆçº§è¿›è¡Œå¯åŠ¨ã€‚å¦‚æœæ²¡æœ‰è¿›å…¥åˆ°Uç›˜ä¸­çš„ç³»ç»Ÿï¼Œå¯ä»¥åœ¨ ç¡¬ç›˜->é«˜çº§ é€‰é¡¹ä¸­æŠŠUç›˜è®¾ç½®ä¸º **SCSI 0:X**ï¼ŒæŠŠæœ¬åœ°ç£ç›˜è®¾ç½®ä¸º **SCSI 0:Y**ï¼Œå…¶ä¸­`X`å’Œ`Y`éƒ½ä¸åŸæ¥çš„å€¼ä¸ä¸€è‡´ï¼Œä¸”`X`æ¯”`Y`å°ã€‚è°ƒæ•´Uç›˜å¯åŠ¨ä¼˜å…ˆçº§æ¯”æœ¬åœ°ç£ç›˜å¯åŠ¨ä¼˜å…ˆçº§é«˜ä¸€çº§ï¼Œå†æ¬¡è¿›å…¥ç³»ç»Ÿã€‚
>
> æ³¨2ï¼šç‰©ç†è®¾å¤‡ä¸­ä¸å­˜åœ¨è¿™ç§æƒ…å†µï¼Œä¼šä¸¥æ ¼æŒ‰ç…§ BIOS ä¸­è®¾å®šçš„å¯åŠ¨ä¼˜å…ˆçº§è¿›è¡Œå¯åŠ¨ã€‚

è¿›å…¥ç³»ç»Ÿåæ‰§è¡Œ`fdisk -l`ï¼Œç¡®è®¤éœ€è¦ resize çš„è®¾å¤‡ä¸º`/dev/sdb2`ã€‚

![fdiskæ‰§è¡ŒæŒ‡ä»¤1](./pics/OpenWrt/4.1.5_2.png)

æ‰§è¡Œ`fdisk /dev/sdb`æŒ‡ä»¤ã€‚åœ¨`fdisk`çš„äº¤äº’ç•Œé¢è¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼š

```python
p           â† æ‰“å°å½“å‰åˆ†åŒºè¡¨
e           â† æ‰©å……åˆ†åŒº
2           â† æ‰©å…… /dev/sdb2
[Enter]     â† ä½¿ç”¨é»˜è®¤å€¼
w           â† å†™å…¥å¹¶é€€å‡º
# q         â† ç›´æ¥é€€å‡º
```

![fdiskæ‰§è¡ŒæŒ‡ä»¤2](./pics/OpenWrt/4.1.5_3.png)

> fdisk çš„ e æŒ‡ä»¤(å³ resize æŒ‡ä»¤)åœ¨ fdisk (util-linux 2.39) ç‰ˆæœ¬ä¸‹ä¸æ”¯æŒï¼Œåœ¨ fdisk (util-linux 2.40.2) åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒã€‚å¦‚æœ fdisk ç‰ˆæœ¬ä¸æ”¯æŒï¼Œå°±ä½¿ç”¨ parted æ‰©å®¹ã€‚

ç›®å‰å®Œæˆäº†ç»™ç£ç›˜åˆ†åŒºæ‰©å®¹ï¼Œè¿˜æ²¡æœ‰ç»™ç£ç›˜åˆ†åŒºä¸Šçš„æ–‡ä»¶ç³»ç»Ÿæ‰©å®¹ã€‚

> ç»™æ–‡ä»¶ç³»ç»Ÿæ‰©å®¹çš„`resize2fs`æŒ‡ä»¤ä¸èƒ½å¯¹å·²æŒ‚è½½çš„æ ¹åˆ†åŒºåœ¨çº¿æ‰§è¡Œï¼Œéœ€è¦åœ¨å¦ä¸€å—ç£ç›˜ä¸­åˆ·å…¥OpenWrtç³»ç»Ÿï¼Œå†åœ¨æ–°åˆ·å…¥çš„ç³»ç»Ÿä¸­æ‰§è¡Œï¼ˆè¿™æ ·ç›¸å¯¹äºå®Œæˆåˆ†åŒºæ‰©å®¹çš„ç£ç›˜æ¥è¯´æ˜¯ç¦»çº¿æ‰§è¡Œï¼‰ã€‚

æ‰§è¡Œ`opkg update && opkg install resize2fs`ï¼Œå†æ‰§è¡Œ`resize2fs /dev/sdb2`ã€‚

çœ‹åˆ°å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ï¼Œè¯´æ˜éœ€è¦æ‰©å®¹çš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼æœ‰æŸåï¼Œéœ€è¦æ‰§è¡Œ`e2fsck`æŒ‡ä»¤æ¥å¼ºåˆ¶æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿå®Œæ•´æ€§å¹¶ä¿®å¤é”™è¯¯ã€‚

![resizeæŠ¥é”™ä¿¡æ¯](./pics/OpenWrt/4.1.5_4.png)

`e2fsck`æŒ‡ä»¤ä¸éœ€è¦å†é¢å¤–å®‰è£…ä¾èµ–ï¼Œç›´æ¥æ‰§è¡Œå³å¯ã€‚åœ¨æ‰§è¡Œå®Œ`e2fsck -f /dev/sdb2`æŒ‡ä»¤åï¼Œç»§ç»­æ‰§è¡Œ`resize2fs /dev/sdb2`æŒ‡ä»¤ã€‚çœ‹åˆ° *The filesystem on /dev/sdb2 is now 520123 (4k) blocks long* çš„æç¤ºè¯´æ˜å·²æ‰©å®¹å®Œæ¯•ã€‚å…¶ä¸­ 4k è¡¨ç¤ºæ¯ä¸ªå—(**block**)çš„å¤§å°ï¼Œ520123è¡¨ç¤ºå—çš„æ€»æ•°ã€‚è¿™ä¸¤è€…çš„ä¹˜ç§¯å°±æ˜¯[4.1.2èŠ‚](#412-vmwareè™šæ‹Ÿæœºé…ç½®)åˆ›å»ºç¡¬ç›˜2æ—¶è®¾å®šçš„ç£ç›˜å®¹é‡2GBã€‚

![resizeæˆåŠŸä¿¡æ¯](./pics/OpenWrt/4.1.5_5.png)

æ­¤æ—¶ç§»é™¤Uç›˜ï¼Œé‡æ–°è¿›å…¥æœ¬åœ°ç£ç›˜ä¸­çš„ç³»ç»Ÿï¼Œèƒ½å¤Ÿé¡ºåˆ©è¿›å…¥ç³»ç»Ÿã€‚

> å¦ä¸€ç§ç»™ç£ç›˜åˆ†åŒºæ‰©å®¹çš„æ–¹æ³•æ˜¯ä½¿ç”¨`parted`ã€‚
>
> æ‰§è¡Œ`opkg update && opkg install parted`ï¼Œå®‰è£…å®Œæ¯•åæ‰§è¡Œ`parted`æŒ‡ä»¤ã€‚
>
> ![partedç•Œé¢](./pics/OpenWrt/4.1.5_6.png)
> > æ³¨ï¼šéƒ¨åˆ†ç‰ˆæœ¬çš„ parted æ‰©å®¹æŒ‡ä»¤æ˜¯`resize`è€Œä¸æ˜¯`resizepart`ï¼Œä½¿ç”¨å‰æœ€å¥½ç”¨`help`æŒ‡ä»¤æŸ¥çœ‹ä¸€ä¸‹å…·ä½“çš„æ‰©å®¹æŒ‡ä»¤ã€‚

### 4.2 wanå’Œlançš„å®è´¨

OpenWrtçš„wanå£å’Œlanå£å®è´¨åŒºåˆ«å°±æ˜¯**é˜²ç«å¢™é…ç½®**ä¸åŒã€‚åªè¦æ›´æ”¹ç›¸åº”çš„é˜²ç«å¢™é…ç½®ï¼Œå°±èƒ½å®ç°wanå’Œlançš„äº’ç›¸è½¬æ¢ã€‚

è·¯ç”±çš„æ ¸å¿ƒæ˜¯**è½¬å‘**ï¼ˆ*Forward*ï¼‰ï¼Œè€Œä¸æ˜¯NATã€‚è¿™é‡Œçš„è½¬å‘æ˜¯æŒ‡å½“æŒ‡å®šç½‘å…³çš„è®¿é—®è¯·æ±‚åŠDNSæŸ¥è¯¢è¯·æ±‚ç­‰æ— æ³•åœ¨æœ¬åŒºåŸŸï¼ˆ*Zone*ï¼‰å®ç°æ—¶å°±ä¼šå°†è¯·æ±‚è½¬å‘ç»™OpenWrtå†…å…¶ä»–åŒºåŸŸã€‚

ä¸‹é¢å°†ä»¥ [2.4èŠ‚](#24-è¿›å…¥luciä¸»ç•Œé¢) è®¾ç½®å®Œæ¯•çš„OpenWrtç³»ç»Ÿä¸ºåŸºç¡€è®²è§£å¦‚ä½•å®ç°wanå’Œlançš„äº’ç›¸è½¬æ¢ã€‚

é¦–å…ˆä¸ºè¯¥è™šæ‹Ÿæœºæ·»åŠ ä¸€ä¸ªæ–°çš„ç½‘ç»œé€‚é…å™¨ï¼Œé€‰æ‹©å‰è¿°çš„VMnet1å­ç½‘(host onlyæ¨¡å¼)ï¼Œè¯¥ç½‘å¡å°†ç”¨ä½œlanå£ã€‚è€ŒåŸå…ˆç”¨ä½œlanå£ã€æ¡¥æ¥å®¿ä¸»æœºæ— çº¿ç½‘å¡çš„VMnet2å°†ç”¨ä½œwanå£ã€‚æ·»åŠ ç½‘ç»œé€‚é…å™¨åOpenWrtè‡ªåŠ¨æ‰§è¡Œ`service network restart`ã€‚

æµè§ˆå™¨è®¿é—®`192.168.1.31`ï¼Œè¿›å…¥LuCIè®¾ç½®ç•Œé¢ã€‚ç”±äºä»…ä»LuCIè®¾ç½®ç•Œé¢æ— æ³•å°†å·²ç»åˆ›å»ºå¥½çš„æ¥å£æ›´æ”¹åå­—ï¼Œå› æ­¤é€‰æ‹©åœ¨ Interfaces é€‰é¡¹å¡ç•Œé¢åˆ é™¤lanæ¥å£ï¼Œç„¶åå†é‡æ–°åˆ›å»ºæ¥å£ã€‚

é¦–å…ˆåˆ›å»ºwanæ¥å£ï¼Œè¯¥æ¥å£ç”¨åˆ°eth0ï¼Œåè®®ä¸ºDHCPå®¢æˆ·ç«¯ï¼Œè¿™æ ·å¯ä»¥è‡ªåŠ¨è·å–ä¸»è·¯ç”±åˆ†é…çš„ipå’Œç½‘å…³ã€‚

![åˆ›å»ºwanæ¥å£](./pics/OpenWrt/4.7.png)

åˆ›å»ºå®Œwanæ¥å£åè‡ªåŠ¨è¿›å…¥æ¥å£çš„è®¾ç½®ç•Œé¢ã€‚åœ¨ Advanced Settings é€‰é¡¹å¡ç•Œé¢å–æ¶ˆå‹¾é€‰ Use DNS servers advertised by peer é€‰é¡¹ï¼Œç„¶ååœ¨ Use custom DNS servers è¾“å…¥æ¡†ä¸­è¾“å…¥DNSæœåŠ¡å™¨åœ°å€`8.8.8.8`å’Œ`8.8.4.4`ã€‚

åœ¨ FireWall Settings é€‰é¡¹å¡ç•Œé¢é€‰æ‹©é˜²ç«å¢™åŒºåŸŸä¸ºé¢„è®¾çš„wanã€‚

![wanæ¥å£é˜²ç«å¢™åŒºåŸŸè®¾ç½®](./pics/OpenWrt/4.8.png)

å…¶ä»–é€‰é¡¹ä¿æŒé»˜è®¤ï¼Œå®Œæˆwanæ¥å£çš„åˆ›å»ºå’Œè®¾ç½®ã€‚

> æ³¨æ„ï¼šæ­¤æ—¶ä¸è¦åœ¨LuCIç•Œé¢é€‰æ‹© Save & Applyï¼Œå› ä¸ºé¢„è®¾çš„wanåŒºåŸŸæ‹’ç»è¾“å…¥(*Zone â‡’ Forwardings* çš„ *input* å±æ€§ä¸º *reject*)ã€‚è¦åœ¨å®Œæˆlanæ¥å£çš„åˆ›å»ºå’Œè®¾ç½®ä¹‹åæ‰èƒ½ä¿å­˜å¹¶åº”ç”¨ã€‚

æ¥ä¸‹æ¥åˆ›å»ºlanæ¥å£ï¼Œè¯¥æ¥å£ç”¨åˆ°eth1ï¼Œåè®®ä¸º Static addressã€‚

![åˆ›å»ºlanæ¥å£](./pics/OpenWrt/4.9.png)

åˆ›å»ºå®Œlanæ¥å£åè‡ªåŠ¨è¿›å…¥æ¥å£çš„è®¾ç½®ç•Œé¢ã€‚éœ€è¦å…ˆè®¾ç½®lançš„ipå’Œå­ç½‘æ©ç ã€‚ç”±äºVMnet1çš„ç½‘æ®µæ˜¯`192.168.10.0`ï¼Œå› æ­¤lanå¯ä»¥è®¾ç½®ä¸º`192.168.10.1/24`ã€‚ç½‘å…³ä¿æŒä¸ºç©ºï¼Œå› ä¸ºä»lanåˆ°wançš„é€šä¿¡æ˜¯è½¬å‘ï¼Œåœ¨é˜²ç«å¢™è®¾ç½®é‡ŒZone lanå’ŒZone wanä¹‹é—´å·²ç»é»˜è®¤å¼€å¯äº†Forwardæƒé™ã€‚

![lanæ¥å£è®¾ç½®1](./pics/OpenWrt/4.10.png)

åŒç†ï¼Œåœ¨ Advanced Settings é€‰é¡¹å¡ç•Œé¢ä¸‹çš„ Use custom DNS servers ä¹Ÿä¿æŒä¸ºç©ºå³å¯ï¼Œå½“è¿æ¥lanæ¥å£çš„è®¾å¤‡å‘èµ·DNSè¯·æ±‚æ—¶è¯¥è¯·æ±‚ä¼šè¢«ç›´æ¥è½¬å‘ç»™wanæ¥å£å¤„ç†ã€‚

åœ¨ FireWall Settings é€‰é¡¹å¡ç•Œé¢é€‰æ‹©é˜²ç«å¢™åŒºåŸŸä¸ºé¢„è®¾çš„lanã€‚

![lanæ¥å£è®¾ç½®2](./pics/OpenWrt/4.11.png)

åœ¨ DHCP Server é€‰é¡¹å¡ç•Œé¢é€‰æ‹© Set up DHCP Serverã€‚ç”±äº IPv6 assignment length é€‰é¡¹åœ¨æ–°å»ºæ¥å£çš„æ—¶å€™é»˜è®¤ä¸ºdisabledï¼Œå› æ­¤ DHCP Server -> IPv6 Settings ä¸‹çš„RA-Serviceã€DHCPv6-Serviceå’ŒNDP-Proxyé»˜è®¤ä¸ºdisabledï¼Œä¸éœ€è¦å†åšé¢å¤–ä¿®æ”¹ã€‚

å®Œæˆlanæ¥å£çš„åˆ›å»ºå’Œè®¾ç½®ä¹‹åï¼Œè¿›å…¥ Interfaces å³è¾¹çš„ Devices é€‰é¡¹å¡ç•Œé¢ï¼Œä¿®æ”¹br-lanè®¾ç½®ã€‚ç”±äºäº’æ¢äº†lanå’Œwanï¼Œå› æ­¤éœ€è¦åœ¨ Bridge Ports é€‰é¡¹å–æ¶ˆå‹¾é€‰eth0å¹¶å‹¾é€‰eth1ã€‚

![br-lanè®¾ç½®](./pics/OpenWrt/4.12.png)

æœ€ååœ¨LuCIä¸»ç•Œé¢é€‰æ‹© Save & Applyã€‚ç”±äºlançš„ç½‘æ®µä»åŸæ¥çš„`192.168.1.0`æ›´æ”¹ä¸ºäº†`192.168.10.0`ï¼Œå› æ­¤ä¼šå¼¹å‡ºå¦‚ä¸‹è­¦å‘Šã€‚

![LuCIè­¦å‘Š](./pics/OpenWrt/4.13.png)

ç›´æ¥é€‰æ‹©åº”ç”¨å¹¶ä¿å­˜è®¾ç½®å³å¯ã€‚æ­¤æ—¶åœ¨æµè§ˆå™¨ç•Œé¢è®¿é—®`192.168.10.1`å°±èƒ½å†é‡æ–°çœ‹åˆ°LuCIç•Œé¢ï¼Œè¿™æ ·å°±è¡¨ç¤ºè®¾ç½®æˆåŠŸäº†ã€‚

ä¸‹é¢åšä¸€é¡¹å®éªŒã€‚

åœ¨wanæ¥å£ Use custom DNS servers é€‰é¡¹åˆ é™¤ä¹‹å‰è®¾ç½®çš„DNSæœåŠ¡å™¨ï¼Œä½¿è¯¥é¡¹ä¸ºç©ºï¼ŒåŒæ—¶ä¿æŒ Use DNS servers advertised by peer é€‰é¡¹ä¸ºå–æ¶ˆå‹¾é€‰çŠ¶æ€ã€‚åœ¨lanæ¥å£è®¾ç½®DNSæœåŠ¡å™¨ä¸º`8.8.8.8`å’Œ`8.8.4.4`ã€‚

ä¿å­˜å¹¶åº”ç”¨ä¹‹åï¼Œåœ¨OpenWrtå†…è¾“å…¥`ping baidu.com`ã€‚å‘ç°ç™¾åº¦åŸŸåè¢«è§£æä¸ºIPåœ°å€`39.156.66.10`ã€‚è¿™æ˜¯å› ä¸ºwanå£DNSè¯·æ±‚è¢«è½¬å‘ç»™äº†lanæ¥å¤„ç†ã€‚

æ¥ä¸‹æ¥è¿›å…¥lanåŒºåŸŸçš„é˜²ç«å¢™è®¾ç½®ï¼Œå–æ¶ˆå‹¾é€‰è½¬å‘è‡³wanåŒºåŸŸçš„è½¬å‘æƒé™ã€‚

![é˜²ç«å¢™è®¾ç½®1](./pics/OpenWrt/4.14.png)

åœ¨lanåŒºåŸŸå–æ¶ˆä»lanè‡³wançš„è½¬å‘æƒé™åï¼ŒwanåŒºåŸŸä¼šè‡ªåŠ¨å–æ¶ˆä»lanè‡³wançš„è½¬å‘æƒé™ã€‚è®¾ç½®å®Œåå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![é˜²ç«å¢™è®¾ç½®2](./pics/OpenWrt/4.15.png)

ä¿å­˜å¹¶åº”ç”¨ä¹‹ååœ¨OpenWrtå†…ä½¿ç”¨`reboot`æŒ‡ä»¤é‡å¯ï¼Œè¿™æ ·å¯ä»¥æ¸…é™¤DNSç¼“å­˜ã€‚é‡æ–°è¾“å…¥`ping baidu.com`ã€‚å‘ç°ç™¾åº¦åŸŸåè¢«è§£æä¸ºIPåœ°å€`110.242.68.66`ï¼Œå› ä¸ºæ­¤æ—¶wanæ— æ³•å¤„ç†DNSè¯·æ±‚ï¼Œä¹Ÿæ— æ³•å°†è¯¥è¯·æ±‚è½¬å‘ç»™lanï¼Œåªèƒ½è¾“å‡º(*Output*)ç»™wançš„ç½‘å…³ï¼ˆå³ä¸»è·¯ç”±ï¼‰ã€‚ä¸»è·¯ç”±çš„DNSæœåŠ¡å™¨è®¾ç½®æ˜¯ç”±ç”µä¿¡è¿è¥å•†ä¸‹å‘çš„ï¼Œæ‰€ä»¥æœ€ç»ˆè§£æå‡ºæ¥çš„IPåœ°å€å’Œè°·æ­ŒDNSæœåŠ¡å™¨è§£æå‡ºçš„IPåœ°å€ä¸åŒã€‚

ç„¶åç»™wanæ¥å£æ·»åŠ DNSæœåŠ¡å™¨`8.8.8.8`å’Œ`8.8.4.4`ã€‚é‡æ–°è¾“å…¥`ping baidu.com`ã€‚å‘ç°ç™¾åº¦åŸŸååˆé‡æ–°è¢«è§£æä¸ºIPåœ°å€`39.156.66.10`ï¼Œè¿™è¯´æ˜DNSè¯·æ±‚ç”±wanå£æ¥å¤„ç†ï¼Œè€Œä¸æ˜¯äº¤ç»™ä¸Šçº§çš„ä¸»è·¯ç”±å¤„ç†ã€‚

### 4.3 æ›´æ¢VMwareè™šæ‹Ÿæœºç½‘å¡é©±åŠ¨

ä½¿ç”¨lan-wanç»“æ„çš„è·¯ç”±è¿›è¡Œæµ‹é€Ÿæ—¶ç»å¸¸ä¼šåœ¨æµ‹é€Ÿå‡ ç§’é’Ÿä¹‹åå¡é¡¿ä¸€ä¸‹ï¼Œç„¶åOpenWrtå†…logæ˜¾ç¤º`e1000 detected Tx Unit Hang`ï¼Œåº”è¯¥æ˜¯ç½‘å¡ç«¯å£çŸ­æ—¶é—´ä¼ è¾“å¤§é‡æ•°æ®æ—¶å‘ç”Ÿé˜»å¡ã€‚ä¸ºäº†é¿å…è¿™ç§ç°è±¡çš„å‘ç”Ÿéœ€è¦æŠŠ`e1000`é©±åŠ¨æ›´æ¢ä¸º`vmxnet3`é©±åŠ¨ã€‚

å³å‡»è™šæ‹Ÿæœºé€‰é¡¹å¡ï¼Œé€‰æ‹©æ‰“å¼€è™šæ‹Ÿæœºç›®å½•ï¼Œæ‰¾åˆ°åç¼€ä¸º`.vmx`çš„æ–‡ä»¶å¹¶ç”¨æ–‡æœ¬ç¼–è¾‘å·¥å…·æ‰“å¼€ï¼Œæ‰¾åˆ°`ethernet[N].virtualDev = "e1000"`ï¼Œä¿®æ”¹ä¸º`ethernet[N].virtualDev = "vmxnet3"`ã€‚ï¼ˆå¯ä»¥ç›´æ¥å…¨å±€æœç´¢`e1000`ç„¶åæ›¿æ¢ä¸º`vmxnet3`ï¼‰

### 4.4 å®ä½“è·¯ç”±é‡‡ç”¨æ—è·¯ç½‘å…³ç»“æ„çš„å¼Šç«¯

å¦‚æœè®¾å¤‡æ˜¯ç”¨wifiè¿æ¥åˆ°ä¸»è·¯ç”±ï¼Œé‚£ä¹ˆå¿…é¡»è¦å¼€å¯æ—è·¯ç½‘å…³lanå£çš„NATï¼ˆå³å‹¾é€‰ Masquerading é€‰é¡¹ï¼‰ï¼Œå¦åˆ™ä¼šå¯¼è‡´è®¾å¤‡æ— æ³•æ­£å¸¸è®¿é—®ç½‘é¡µã€‚

### 4.5 OpenWrtå®‰è£…ç»¿è”USBç½‘å¡é©±åŠ¨

ä» [ç»¿è”å®˜ç½‘](https://www.lulian.cn/download/list-34-cn.html "https://www.lulian.cn/download/list-34-cn.html") æŸ¥åˆ°ç»¿è”USB/Type-Cåƒå…†ç½‘å¡èŠ¯ç‰‡å‹å·ä¸ºAX88179ã€‚

åœ¨ [OpenWrtå®˜ç½‘çš„kernel modsåˆ—è¡¨](https://openwrt.org/packages/index/kernel-modules "https://openwrt.org/packages/index/kernel-modules") ä¸­ç›´æ¥æœç´¢AX88179ï¼Œå¾—åˆ°å…¶kmodåŒ…å…¨ç§°ä¸º`kmod-usb-net-asix-ax88179`ã€‚

æ¥ä¸‹æ¥è¿›å…¥OpenWrtï¼Œè¾“å…¥æŒ‡ä»¤`opkg update && opkg install kmod-usb-net-asix-ax88179`å®‰è£…USBç½‘å¡é©±åŠ¨ã€‚è¿™æ ·ç»¿è”çš„USBç½‘å¡å°±èƒ½åœ¨OpenWrtç³»ç»Ÿé‡Œæ­£å¸¸ä½¿ç”¨ã€‚å®æµ‹å°†æ­¤USBç½‘å¡æ’åœ¨å¤è‘£ç¬”è®°æœ¬æƒ æ™®æš—å½±ç²¾çµ2proä¸Šé¢å¯ä»¥è·‘åˆ°900+Mbpsï¼Œæ¥è¿‘åƒå…†ç½‘é€Ÿä¸Šé™ã€‚

å¦‚æœè€å¼ç”µè„‘æœ‰USB3.0æ¥å£ï¼Œä½†æ˜¯ç½‘å¡åªæœ‰ç™¾å…†ä¸Šé™ï¼Œå°±å¯ä»¥è´­ä¹°ç»¿è”çš„USBåƒå…†ç½‘å¡ï¼Œç„¶åç”¨ [4.1èŠ‚](#411-å°†imgæ–‡ä»¶çƒ§å½•å…¥uç›˜) æ‰€è¿°çš„æ–¹æ³•è®©è€å¼ç”µè„‘è¿è¡Œä¸ŠOpenWrtç³»ç»Ÿï¼Œå®‰è£…å¥½ç½‘å¡é©±åŠ¨ä¹‹åå°±å¯ä»¥æŠŠè€å¼ç”µè„‘å˜æˆä¸€å°çœŸæ­£çš„è·¯ç”±å™¨ï¼Œè¿™æ ·å°±ä¸éœ€è¦å†é¢å¤–è´­ä¹°x86æ¶æ„çš„è½¯è·¯ç”±ã€‚

### 4.6 OpenWrté˜²ç«å¢™é…ç½®è¯´æ˜

![é˜²ç«å¢™é…ç½®1](./pics/OpenWrt/4.6_1.png)

![é˜²ç«å¢™é…ç½®2](./pics/OpenWrt/4.6_2.png)

### 4.7 OpenWrtå®‰è£…UUåŠ é€Ÿå™¨æ’ä»¶

UUåŠ é€Ÿå™¨æ’ä»¶ç›®å‰å·²æ”¯æŒnftablesã€‚

sshè¿æ¥OpenWrtåè¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼š

```sh
wget https://uurouter.gdl.netease.com/uuplugin-script/openwrt/install/v2/install.sh
/bin/sh install.sh openwrt $(uname -m)
# è‹¥æ²¡æœ‰å®‰è£… kmod-tun éœ€è¦æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤:
# (è‹¥å®‰è£…æœ‰ OpenClash ç­‰æ’ä»¶åº”è¯¥å·²å®‰è£…å¥½äº† kmod-tun å‰ç½®)
opkg update && opkg install kmod-tun
```

åœ¨UUåŠ é€Ÿå™¨çš„æ‰‹æœºappä¸Šé€‰æ‹©å®‰è£…è·¯ç”±å™¨æ’ä»¶ï¼Œå¹¶ä¾ç…§å¼•å¯¼æ“ä½œï¼Œç„¶åå°±èƒ½é€šè¿‡æ‰‹æœºappæ¥æ§åˆ¶è·¯ç”±å™¨é‡Œçš„UUåŠ é€Ÿå™¨å¼€å…³åŠèŠ‚ç‚¹é€‰æ‹©ã€‚

æ³¨æ„æ­¤æ—¶å³ä½¿æ¸¸æˆè®¾å¤‡è¿æ¥ä¸ŠåŠ é€Ÿå™¨ä¹Ÿæ— æ³•è®¿é—®ç½‘ç»œï¼Œè¿˜éœ€è¦ä¿®æ”¹é˜²ç«å¢™è®¾ç½®ã€‚

> è¿æ¥åŠ é€Ÿå™¨è¿™ä¸€æ­¥æ˜¯ä¸ºäº†è®© OpenWrt ç³»ç»Ÿä¸­è¯†åˆ«åˆ° `tun163` è¿™ä¸ªè®¾å¤‡ï¼Œä»¥ä¾¿äºè¿›è¡Œåç»­çš„é˜²ç«å¢™è®¾ç½®ç¯èŠ‚ã€‚
>
> æ³¨ï¼šå¦‚æœè¿æ¥äº†ä¸¤å°æ¸¸æˆè®¾å¤‡ï¼ŒOpenWrt ä¸­ä¼šå‡ºç° `tun163` å’Œ `tun164` ä¸¤ä¸ªè®¾å¤‡ã€‚

æ–°å»ºé˜²ç«å¢™ Zoneï¼Œå‘½åä¸º UUã€‚ä¿®æ”¹ Input å’Œ Output è®¾ç½®ï¼Œéƒ½æ”¹ä¸º acceptã€‚å†ä¿®æ”¹åŒºåŸŸé—´è½¬å‘è®¾ç½®ï¼Œå…è®¸è½¬å‘è‡³(**forward to**)å’Œè½¬å‘è‡ª(**forward from**)å½“å‰çš„ lan Zoneã€‚

![UUZoneè®¾ç½®1](./pics/OpenWrt/4.7_1.png)

æ¥ä¸‹æ¥ç»‘å®š UU çš„ tun è®¾å¤‡åˆ° UU Zoneã€‚

![UUZoneè®¾ç½®2](./pics/OpenWrt/4.7_2.png)

ä¸‹é¢æ˜¯é˜²ç«å¢™è®¾ç½®æˆåŠŸçš„ç•Œé¢ã€‚

![UUZoneè®¾ç½®æˆåŠŸ](./pics/OpenWrt/4.7_3.png)

æ›´æ–°é˜²ç«å¢™è®¾ç½®åæ¸¸æˆè®¾å¤‡å°±èƒ½æˆåŠŸè”ç½‘äº†ã€‚

![æˆåŠŸç•Œé¢](./pics/OpenWrt/4.7_4.png)

> å¼€å¯UUåŠ é€Ÿå™¨æ—¶ä¹Ÿå¯ä»¥ä¿æŒ OpenClash å¼€å¯ï¼Œåªè¦ç¡®ä¿ä¸åœ¨UUåŠ é€Ÿå™¨ç”Ÿæ•ˆä¸­æ—¶å…³é—­æˆ–å¼€å¯ OpenClash å³å¯ã€‚

### 4.8 OpenWrtå®‰è£…Openclashæ’ä»¶

å®‰è£…è¿‡ç¨‹ä¸­å¦‚æœæŠ¥é”™ï¼š*opkg_install_cmd: cannot install package dnsmasq-full*ï¼Œè¯´æ˜æƒ³è¦å®‰è£…çš„ dnsmasq-full å’Œæœ¬åœ°å·²æœ‰çš„ dnsmasq å†²çªï¼Œéœ€è¦å…ˆå¸è½½æœ¬åœ°çš„ dnsmasqã€‚

æ‰§è¡ŒæŒ‡ä»¤`opkg remove dnsmasq && opkg install dnsmasq-full`ï¼Œç¡®ä¿å¸è½½ dnsmasq å’Œå®‰è£… dnsmasq-full åŒæ—¶è¿›è¡Œã€‚

***

![End.](./pics/OpenWrt/end.png)
